SEPP Demo 
==========
    
TODO:       
- Change SEPPsim to include more realistic answer to AMF-UDM registration
- Indirect routing, SEPPSIM needs to be more flexible with DNS lookups

ADD:
Temporary blocking


sepp-testcases/src/main/java/com/ericsson/jcat/esc/sepp/tests/N32_sepp.java


General Prerequisites
========================

Set Environment Variables and enable monitor
--------------------------------------------
#export NAMESPACE=5g-bsf-eedcsi
#alias k="kubectl -n $NAMESPACE"

#maybe needed: 
#$GIT_PATH/5g_proto/scripts/install_certs.sh  nbi

export NODE_IP=$(kubectl get nodes --namespace $NAMESPACE -o jsonpath="{.items[3].status.addresses[0].address}")

kubectl --namespace $NAMESPACE scale deploy eric-sc-monitor --replicas=1

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?command=list" |jq


Set Own Domain for SEPPsim
---------------------------
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc072.mcc262.3gppnetwork.org"}' | jq

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org"}' | jq

export SEPPSIMP7_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p7-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
echo $SEPPSIMP7_SVC_IP
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","ownIpAddress": "127.0.0.1"}' | jq

export SEPPSIMP8_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p8-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
echo $SEPPSIMP8_SVC_IP
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p8&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc060.mcc240.3gppnetwork.org","ownIpAddress": "127.0.0.1"}' | jq



Scale to one SEPP worker
---------------------------
kubectl --namespace $NAMESPACE scale deploy eric-sepp-worker --replicas=1


load TAR into container, needed for knsiff:
------------------------
cat /usr/bin/tar | k exec -i -c eric-sepp-worker $SEPP_WORKER_POD -- tee /usr/bin/tar > /dev/null
k exec -it $SEPP_WORKER_POD -c eric-sepp-worker -- chmod +x /usr/bin/tar



Open CNOM
----------
kgsg eric-tm-ingress-controller-cr # take mapped port of 443
https://nbi.5g-bsf-eedcsi.hahn121.rnd.gic.ericsson.se:30003/em  



Load bash functions for the demo:
---------------------------------
source ~/.bash_functions


function seppResetSeppsims ()
{
        echo "Resetting 5 SEPPsim PODs"
        k delete pods -l app=eric-seppsim-p1 &
        k delete pods -l app=eric-seppsim-p2 &
        k delete pods -l app=eric-seppsim-p3 &
        k delete pods -l app=eric-seppsim-p4 &
        k delete pods -l app=eric-seppsim-p5 &
        k delete pods -l app=eric-seppsim-p6 &
        k delete pods -l app=eric-seppsim-p7 &
}

function seppRemoveSeppsimDisturbances ()
{
        echo "Removing all disturbances on SEPPsim PODs"
        export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
        export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
        export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
        curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p&command=config" -d '{"ownDomain":"region1.amf.5gc.mnc072.mcc262.3gppnetwork.org"}' | jq .results[].config.api.nudmUeContextManagement
}

##function seppAddSeppsimDisturbance ()
##{
##        echo "Adding disturbances ($2) on SEPPsim POD eric-seppsim-p$1"
##        export MONITOR_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sc-monitor)
##        curl -X PUT "http://$NODE_IP:$MONITOR_PORT/monitor/api/v0/commands?target=eric-seppsim-p$1&command=config" -d '{"ownDomain":"region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","api":{"nudmUeContextManagement":{"disturbances":[{"status":$2}]}}}'  | jq .results[0].config.api.nudmUeContextManagement
##
##}

function seppAddSeppsimDisturbance ()
{
        echo "Adding disturbances (503) on SEPPsim POD eric-seppsim-p$1"
        export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
        export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
        export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
        curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p$1&command=config" -d '{"ownDomain":"region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","api":{"nudmUeContextManagement":{"disturbances":[{"status":503}]}}}'  | jq .results[0].config.api.nudmUeContextManagement
}


function seppSetTLS ()
{
        echo "Setting TLS port in VPN config for SEPP"
        export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
        sed -i -E "s/(<port operation=\"merge\">).*(<\/port>)/\1$SEPP_TLS_PORT\2/" ~/demo/sepp_demo/sepp_set_vpn_to_tls.xml
        cat  ~/demo/sepp_demo/sepp_set_vpn_to_tls.xml | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf | grep rpc-reply
}

function seppUnsetTLS ()
{
        echo "Removing TLS port in VPN config for SEPP"
        export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)
        sed -i -E "s/(<port operation=\"merge\">).*(<\/port>)/\1$SEPP_PORT\2/" ~/demo/sepp_demo/sepp_set_vpn_to_non_tls.xml
        cat ~/demo/sepp_demo/sepp_set_vpn_to_non_tls.xml | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf | grep rpc-reply
}

function seppShowEnvoyUDMClusters ()
{
    export SEPP_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
    k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/clusters"  | grep -i udm_

}


Load SEPP config
---------------------
export NAMESPACETOOLS=5g-bsf-eedcsi

#access CLI once before so that sshpass can work later:
ssh -p $CLI_PORT sepp-admin@$NODE_IP

~/bin/update_sepp_config.pl -f ~/demo/sepp_demo/config_new_sepp_demo_2023-04_amf-udm_sc1.11.xml -t $NAMESPACETOOLS
OR config like SCP, without RPs (for UC1- UC5)
~/bin/update_sepp_config.pl -f ~/demo/sepp_demo/config_new_sepp_demo_2022-04_amf-udm_noRP_sc1.8.xml -t $NAMESPACETOOLS

#~/bin/update_sepp_new_config2.pl ~/demo/sepp_demo/config_new_sepp_demo_2022-11_amf-udm_sc1.10_sweden.xml sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org 5g-bsf-eedcsi # to load swedish Config

cat ~/sepp_sample_config.xml | ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf

#print config in envoy
export SEPP_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/config_dump?include_eds"  
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/clusters"  | grep -i udm_
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/clusters"  | grep -i udm_ | grep host
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/listeners"
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/stats"
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/stats/prometheus" |grep roam

seppShowEnvoyUDMClusters



Add RootCA "testca" to truststore:
----------------------------------------
cat $GIT_PATH/5g_proto/.certificates/rootca/cert-*
base64 -w 0 $GIT_PATH/5g_proto/.certificates/rootca/cert.pem

ssh -p $CLI_PORT expert@$NODE_IP
config
truststore certificates sc-traf-root-ca-list1 install-certificate-pem name testca pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVWRENDQXJ5Z0F3SUJBZ0lJVVdRdzlxcnpLdG93RFFZSktvWklodmNOQVFFTEJRQXdVREVMTUFrR0ExVUUKQmhNQ1IwVXhEekFOQmdOVkJBY01Ca0ZoWTJobGJqRVJNQThHQTFVRUNnd0lSWEpwWTNOemIyNHhEREFLQmdOVgpCQXNNQTBWRVJERVBNQTBHQTFVRUF3d0dkR1Z6ZEdOaE1CNFhEVEl5TURReE1qRXhOVGt6TTFvWERUSXpNRFF4Ck1qRXhOVGt6TTFvd1VERUxNQWtHQTFVRUJoTUNSMFV4RHpBTkJnTlZCQWNNQmtGaFkyaGxiakVSTUE4R0ExVUUKQ2d3SVJYSnBZM056YjI0eEREQUtCZ05WQkFzTUEwVkVSREVQTUEwR0ExVUVBd3dHZEdWemRHTmhNSUlCb2pBTgpCZ2txaGtpRzl3MEJBUUVGQUFPQ0FZOEFNSUlCaWdLQ0FZRUF1YWZkNGNDQXNlRkdmUmVyZW03Mkd1WjZONFJaCm50VGhieE5MVE9qT2YraGxrMkczQWxvOG9MRGU3T0c0WEJlL2g0WWl6aVlhcmRrQjNLR250TnMra3Rnc2Y1MHcKcldZM25FcmlCcHpJNWVJM3hDTCs0NUlJblI0VG1rbkk0L2FaS1dhUC9tbkh6TFRDSUpEQ3B0ZXc2aVZlQVBzSgpGSE42bnVSb3dZbVhlTXRjVWxwc242K0VPdUZNb2dlMXZQeVBFalFGMDlTNDVlejF3UCszN3VITHdJbThsVmZWClRpMDB2K2ZleW5mbkdiVk8zcUtNcUFHQ0R0SHpSNEVtQVJWUGZvbGM1bGczTVBvaGNzS0xFbW9McW1sbHZWYUsKSjgxbVZtU25zN28yK2kxOWdzV2N5RmZQdU0xMVVyMGZhL2FLa29lanVqVFZqeTRaQTA1K0ttZXdYdCtvZEJVZQpFRXVQeFlDeitNeGdxZmtLejJzRTF0ZllLdFRjSmtjck5yWXQ2VFQvakIrNnQwNnRycENqTTFDYjdWMDJObXBQCmRpeVptUTVKT0czTGFXTys2Q2lMVVdBemE4ck9xaE9NVmhlMDhJT3hBYjNiN0tGektaNzErRnB1Yld4OHhFWHYKTnJuQmgrZnlHZXg2WkgvTzNKVUgwRkQxTzBjamdWNWZDZHFsQWdNQkFBR2pNakF3TUE4R0ExVWRFd0VCL3dRRgpNQU1CQWY4d0hRWURWUjBPQkJZRUZJNENsRWVtQTBkbEVIM010MDlibXpReC90Y1FNQTBHQ1NxR1NJYjNEUUVCCkN3VUFBNElCZ1FBTEpLbitZRXREZ3JpRU5ZZ0xjOFhyeHpoSDJsU3ljUEtiRDdCVnpXV1dPT1ZCZW1OcUJUQm0KcEFxaFNaejBwWkxFTnJud25LSkVFWWUxWWlNQ0pPVUM4WU5ydkRhVHcvSlZid0NuRHJYKy9hYmJzVmk3TDFTYwpQVGZCTzk0MitvR1pUdnJIdVpoQUZrMmpXdUFKcG9penlBa2pkZlVxZnR5SnRzOS9OT1BTVXdURFdsVFFHUGpyClE5VUo4b3hLWlp4aDdJall1V3FTck42Z0wxS2lHSHRHRHN0S1d2M1JrVzhxTCt6a0hWR0FCdmo4MDlVUTZ2NkIKMFgxQnR5b2lXT2g5NTVmbTJhaGJTRXdHNXVxbGwxOVltMTFXNDgweS81eGJlbmx0Z21ob3Mrc0NDRmVIYzJaTgo2SzVPVHFQL2ZkQjJ2S1RHQXFWWVR3eThzN2tSK291Tzh1bUtBeFVKb3gydXloTTYzSHVNaW9xNmpSZE5qM1lwCis3WE9VeGJZNENKZWJSQWl0aHkrMWo3VWVvY21sSXovRkw2cGJkQm5ReHRkdkU1TXY4S2lsK0RzSnQ5SDl1SkcKMHJOcnFwZ2IzT1NySG5hZ1Z2SXpyVW1QZ3VPZDhRM2ZtVlU5dy9rUEhuK3RVOWVScVBESmhLK05MQ3pSaFUzQwp3b0RZcHlyNTE3az0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=

truststore certificates sc-traf-root-ca-list2
...


#If wanted, load tcpdumper for SEPP worker 
#-----------------------------------------
#k patch deployment eric-sepp-worker  --patch "$(cat ~/tcpdump.yaml)"
#
#export SEPP_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
#
#k exec -it -c tcpdumper $SEPP_POD -- sh
#
#tcpdump -s 0 -vv -n -w /tmp/capture.pcap
#
#k cp -c tcpdumper $SEPP_POD:/tmp/capture.pcap ~/capture_sepp.pcap


Set DNS entires for all needed PODs in /etc/hosts
-------------------------------------------------
export SEPP_MANAGER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")
export NAMESPACETOOLS=5g-bsf-eedcsi

export UDM1_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p1-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")
export UDM2_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p2-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")
export AMF_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p3-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

export SEPPBE_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p7-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
export SEPPSE_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p8-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager  -- sh -c "echo ${UDM1_SVC_IP} nfUdm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts; echo ${UDM2_SVC_IP} nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts; echo ${AMF_SVC_IP} nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"

kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager -- sh -c "echo ${SEPPBE_SVC_IP} sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org  >> /etc/hosts; echo ${SEPPSE_SVC_IP}  sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org  >> /etc/hosts"


#kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager  -- sh -c "echo ${SCP2_SVC_IP} sepp2.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"
 
#Verify
kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager -- cat /etc/hosts

#--  for SEPP02 ---

export SEPP2_MANAGER_POD=$(kubectl get pods --namespace $NAMESPACE2 -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")
export SEPP1_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-sepp-worker -o jsonpath="{.spec.clusterIP}")                      
export UDM7_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p7-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

kubectl --namespace $NAMESPACE2 exec -it $SEPP2_MANAGER_POD  -- sh -c "echo ${SEPP1_SVC_IP} sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"
kubectl --namespace $NAMESPACE2 exec -it $SEPP2_MANAGER_POD  -- sh -c "echo ${UDM7_SVC_IP} nfudm7.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"
#Verify
kubectl --namespace $NAMESPACE exec -it $SEPPSIM_SEPP2_POD -- cat /etc/hosts

# export SEPPSIM_SEPP2_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-seppsim-p6" -o jsonpath="{.items[0].metadata.name}")
# export UDM7_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p7-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
# kubectl --namespace $NAMESPACE exec -it $SEPPSIM_SEPP2_POD  -- sh -c "echo ${UDM7_SVC_IP} nfudm7.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"
# 
# #Verify
# kubectl --namespace $NAMESPACE exec -it $SEPPSIM_SEPP2_POD -- cat /etc/hosts

If wanted, set SEPP-worker debugging level to TRACE
---------------------------------------------------
Envoy trace logging:
export SEPP_POD=$(kubectl get pods -n $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

kubectl -n $NAMESPACE exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=trace"  
kubectl -n $NAMESPACE exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=info"  

reset; k logs -f $SEPP_POD -c eric-sepp-worker --tail=0  | jl3


If wanted, set SEPP-manger debugging level to TRACE
---------------------------------------------------
SEPP-manager trace logging:

export SEPP_MANAGER_POD=$(kubectl -n $NAMESPACE get pods -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")

export MONITOR_USER=$(kubectl -n $NAMESPACE get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(kubectl -n $NAMESPACE get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(kubectl -n $NAMESPACE get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(kubectl -n $NAMESPACE get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-sepp-m&command=log&logger=com.ericsson.sc.sepp&level=TRACE" | jq

reset; k logs -f $SEPP_MANAGER_POD -c eric-sepp-manager --tail=0  | jl


Prepare Wireshark on UBUNTU
----------------------------
check that Wireshark starts correctly (Xlaunch started?):
export DISPLAY=":0.0"
wireshark

echo "#PODs" > ~/.config/wireshark/hosts
kubectl get pods -A -o=custom-columns=:.status.podIP,:.metadata.name >> ~/.config/wireshark/hosts
echo "#SVCs" >> ~/.config/wireshark/hosts
kubectl get svc -A  -o=custom-columns=:.spec.clusterIP,:.metadata.name | grep -v None >> ~/.config/wireshark/hosts
echo "#NODESs" >> ~/.config/wireshark/hosts
kubectl get nodes   -o=custom-columns=:.status.addresses[0].address,:.metadata.name >> ~/.config/wireshark/hosts
echo "#VDI" >> ~/.config/wireshark/hosts
echo "137.58.207.197    AMF" >> ~/.config/wireshark/hosts
echo "192.168.130.0     AMF" >> ~/.config/wireshark/hosts

sed -i -E 's/eric-seppsim-p1\S+/UDM1/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p2\S+/UDM2/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p3\S+/UDM3/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p4\S+/UDM4/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p5\S+/UDM5/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p6\S+/SEPP2/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p7\S+/SEPP-BE/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p8\S+/SEPP-SE/' ~/.config/wireshark/hosts

#add the SEPPsim service IP addresses as color filters in Wireshark:
sudo ~/seppsim2color.pl


Restart SEPPsims to have all HTTP/2 messages decoded correctly in Wireshark
---------------------------------------------------------------------------
k delete pods -l app=eric-seppsim-p1 &
k delete pods -l app=eric-seppsim-p2 &
k delete pods -l app=eric-seppsim-p3 &
k delete pods -l app=eric-seppsim-p4 &
k delete pods -l app=eric-seppsim-p5 &   
k delete pods -l app=eric-seppsim-p6 & 
k delete pods -l app=eric-seppsim-p7 &

seppResetSeppsims

Wait about 1 min before SEPPSims are able to receive traffic, otherwise they reject with 503

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p6&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc072.mcc262.3gppnetwork.org"}' | jq


Set log level to ERROR in SEPPsims, if load is needed
------------------------------------------------------
SEPPsim trace logging:

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p&command=log&logger=ROOT&level=ERROR" | jq
#New??
#{"loadTestMode":{"isEnabled":"true"},}                                


Register UDM1 without EP, DNS lookup is done in SEPP-Manager
------------------------------------------------------------------------------------------------------

#cat << EOF > ~/demo/sepp_demo/regUDM1_set1_no_EP_100
#curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce100" -H "Content-Type: application/json" -d '{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce100","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"capacity": 100,"locality": "North","nfSetIdList": ["set1.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-1","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}'
#EOF

cat << EOF > ~/demo/sepp_demo/regUDM1_set1_no_EP_100_body.json
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce100","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"capacity": 100,"locality": "North","nfSetIdList": ["set1.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-1","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
EOF


cat << EOF > ~/demo/sepp_demo/regUDM1_set1_no_EP_100_json
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce100" -H "Content-Type: application/json" -d '@/home/eedcsi/demo/sepp_demo/regUDM1_set1_no_EP_100_body.json'
EOF


#while true; do sh ~/demo/sepp_demo/regUDM1_set1_no_EP_100_json;  sleep 50; done



Register UDM2 with EP (IP+Port)  -> SEPPSIM2_POD
---------------------------------------------------

export UDM2_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p2-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM2_set1_100
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce200" -H "Content-Type: application/json" -d '
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce200","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"capacity": 100,"locality": "North","nfSetIdList": ["set1.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-2","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${UDM2_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
'
EOF

#while true; do sh ~/demo/sepp_demo/regUDM2_set1_100;  sleep 50; done


Register UDM3 with EP (IP+Port), prio2  -> SEPPSIM3_POD
-------------------------------------------------------

export UDM3_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p3-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM3_set1
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce300" -H "Content-Type: application/json" -d '
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce300","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm3.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 2,"capacity": 50,"locality": "South","nfSetIdList": ["set1.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-3","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${UDM3_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
'
EOF

#while true; do sh ~/demo/sepp_demo/regUDM3_set1;  sleep 50; done


Register UDM4 with EP (IP+Port)  -> SEPPSIM4_POD
---------------------------------------------------

export UDM4_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p4-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM4_set2
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce400" -H "Content-Type: application/json" -d '{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce400","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"nfSetIdList": ["set2.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-4","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${UDM4_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}'
EOF

while true; do sh ~/demo/sepp_demo/regUDM4_set2;  sleep 50; done
 

Register UDM5 with EP (IP+Port)  -> SEPPSIM5_POD
---------------------------------------------------

export UDM5_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p5-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM5_set2
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce500" -H "Content-Type: application/json" -d '{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce500","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm5.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"nfSetIdList": ["set2.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-5","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${UDM5_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}'
EOF

while true; do sh ~/demo/sepp_demo/regUDM5_set2;  sleep 50; done



Or register UDM2, UDM4 and UDM5 in one go
---------------------------------------------------
while true; do sh ~/demo/sepp_demo/regUDM2_set1_100; sh ~/demo/sepp_demo/regUDM4_set2; sh ~/demo/sepp_demo/regUDM5_set2; sleep 50; done


Register UDM7 with EP (IP+Port)  -> SEPPSIM7_POD
---------------------------------------------------

export UDM7_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p7-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM7_set3
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce700" -H "Content-Type: application/json" -d '{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce700","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm7.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"nfSetIdList": ["set3.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-7","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${UDM7_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}'
EOF

while true; do sh ~/demo/sepp_demo/regUDM7_set3;  sleep 50; done




Remove disturbance on all SEPPsims
----------------------------------
seppRemoveSeppsimDisturbances


set CLI options
-----------------
autowizard false
complete-on-space false
ignore-leading-space true
paginate false
show-defaults true
timestamp disable 


remove Priority Group (subpool) for UDM1
----------------------------------------
cat ~/demo/sepp_demo/remove_priogroup_rr | sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 

#config
#no sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool priority-group NfUdm_rr_pg_prio1
#no sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool priority-group NfUdm_rr_pg_prio2
#commit
#exit
#exit


Start XLauch for Wireshark from Ubuntu
--------------------------------------


# Start loadmeter in VDI:
# -----------------------
# 
#    export MONITOR_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sc-monitor)
# 
#    check in shell that there are counters for CHFSIM1...: 
#    curl -s -X GET "http://$NODE_IP:$MONITOR_PORT/monitor/api/v0/commands?command=counter&target=eric-seppsim-p"  | jq
#       curl -s -X GET "http://$NODE_IP:32461/monitor/api/v0/commands?command=counter&target=eric-seppsim-p"  | jq
# 
#    pkill loadmeter
# 
#    cd ~/bin/
#    ./loadmeter_get_seppsim_counters_udm 5 2
# 
# 
# d) Start Loadmeter with 01_sepp_chfsim_3.ini
#    Load ...
#    Apply
#    "Connected" should be visible in shell where loadmeter script is running
# 

===============================
       USE CASES
===============================


########################################
# UC1:    NRF Discovery, UDM1 and UDM2 #
########################################

5 Min

# SEPP target-nf-set-id used as a filter


----
Preparation
UBUNTU:
export NAMESPACE=5g-bsf-eedcsi
export NAMESPACE2=5g-scp-eedcsi
export SEPP_MANAGER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")

cd ~/ksniff
export DISPLAY=":0.0"

sudo ./kubectl-sniff -c eric-sepp-manager -n $NAMESPACE $SEPP_MANAGER_POD -c eric-sepp-manager &

#VDI:
#Configure a wrong port for NRF and then the correct one to trigger a MAGIC packet
cat ~/demo/sepp_demo/sepp_demo_wrong_nrf_port.xml | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf | grep "<rpc-reply"
cat ~/demo/sepp_demo/sepp_demo_correct_nrf_port.xml | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf | grep "<rpc-reply"

----


        
#in CLI as user sepp-admin, no NFs in the pools, show configuration
sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 
paginate false


#config -> nf-set-id and nf-type:
show running-config sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool
show running-config sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_pr_pool
#
show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool
show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_pr_pool


!!show also routing case and message data


#Show NF data in coming registration message:
cat /home/eedcsi/demo/sepp_demo/regUDM1_set1_no_EP_100_body.json |jq

#Register 2 UDMs: UDM1 and UDM2
while true; do sh ~/demo/sepp_demo/regUDM1_set1_no_EP_100_json; sh ~/demo/sepp_demo/regUDM2_set1_100; sleep 50; done

# SHOW in wireshark DATA received from NRF
# point out difference between UDM1 (no EP) and UDM2

#in CLI as user sepp-admin - NFs show in the dynamic pool
sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 

paginate false

show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool

# point out difference between UDM1 (no EP) and UDM2
# for UDM1, DNS query is done in the SEPP-MANAGER at NF discovery time


########################################
# UC1.1:    NRF Discovery, UDM3        #
########################################

2 Min

# every 5 seconds pulled
# Dynamically update pool when NFs are added in NRF

while true; do sh ~/demo/sepp_demo/regUDM3_set1;  sleep 50; done

# SHOW in wireshark DATA received from NRF has increased by about 500 bytes
# and contains UDM3

#in CLI as user sepp-admin
show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool



++++++++++++++++++++++++++
Stop and save Wireshark
Export Specified Package
UC1_NRF_Discovery
Exit Wireshark
++++++++++++++++++++++++++



########################################
# UC2:   SEPP - Nonfunctional Selection #
########################################

5min

# 3gpp-Sbi-Discovery-nf-set-id: set1.udmset.5gc.mnc072.mcc262
# -> NfUDM_rr_pool  (round robin between UDM1 and UDM2)

----
UBUNTU:
export SEPP_WORKER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
----


#stern seppsim

export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker-2)  # internal NW

# sent to Pool "NfUDM_rr_pool ", UDM1 or UDM2 selected (round robin)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' | jq

#send 100 messages, show 50%/50% distribution
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-100]" -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify

#generate some traffic if wanted and show CNOM!!

curl -s --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-100000]" -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' > /dev/null


++++++++++++++++++++++++++
Stop Wireshark

seppResetSeppsims

Save Wireshark
    Export Specified Package
    UC2_Nonfunctional_Selection

Exit Wireshark
++++++++++++++++++++++++++

curl --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:32363:10.63.143.68" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:32363/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" -H "accept: application/json" -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert /certs/K6.crt --key /certs/K6.key



## #start some K6 load:
## ./loadmeter_get_seppsim_counters_udm 5 2
## 
## #switch to TLS for k6
## seppSetTLS
##

c) copy files to K6 if not already done:
export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
k cp ~/demo/sepp_demo/sepp_stability_test_set1_b.js ${K61_POD}:/tests/sepp_stability_test_set1.js
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/cert.pem ${K61_POD}:/certs/K6.crt
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/key.pem ${K61_POD}:/certs/K6.key

export K62_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[1].metadata.name}")
k cp ~/demo/sepp_demo/sepp_stability_test_set1_b.js ${K62_POD}:/tests/sepp_stability_test_set1.js
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/cert.pem ${K62_POD}:/certs/K6.crt
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/key.pem ${K62_POD}:/certs/K6.key


export SEPP_INT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)
export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
echo $SEPP_INT_TLS_PORT; echo $NODE_IP
   
k exec -it $K61_POD -- sh -c "pkill k6; k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=${NODE_IP} -e SEPP_PORT=${SEPP_INT_TLS_PORT} -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=100 -e HOLDDURATION=100s -e RAMPDURATION=1s sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report"

pkill k6; k6 run -v -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=10.63.143.68 -e SEPP_PORT=32389 -e RPS=100 -e HOLDDURATION=10s -e RAMPDURATION=1s sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report

#pkill k6; k6 run -e FACTOR=6 -e SEPP_IP=10.63.143.68 -e SEPP_PORT=32703 -e RPS=100 -e SET=set1.udmset.5gc.mnc072.mcc262 -e RAMPDURATION=1s -e HOLDDURATION=1h sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report 

#pkill k6; k6 run -v -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=10.63.143.68 -e SEPP_PORT=32389 -e RPS=100  -e RR=10000 sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report 

## 
## #pkill k6; k6 run  -e SEPP_IP=10.63.142.199 -e SEPP_PORT=32703 -e RPS=100 -e SET=set1.udmset.5gc.mnc072.mcc262 -e RAMPDURATION=1s -e HOLDDURATION=1h -e TYPE=FW sepp_stability_demo_set_apiroot.js --insecure-skip-tls-verify  --no-usage-report 
## 
## 
## #pkill k6; k6 run  -e SEPP_IP=10.63.142.199 -e SEPP_PORT=32703 -e RPS=100 -e SET=set1.udmset.5gc.mnc072.mcc262 -e RAMPDURATION=1s -e HOLDDURATION=1h  sepp_stability_demo_set.js --insecure-skip-tls-verify  --no-usage-report 
## 
## 
## #pkill k6; k6 run  -e SEPP_IP=10.63.142.199 -e SEPP_PORT=32703 -e FW=100 --max 10 --vus 10 --duration 1h sepp_stability_test_3_forward_http_sepp-de.js --insecure-skip-tls-verify --rps 100 --no-usage-report 
## 
## 
## from 192.168.215.64
## 
## #curl -v -X POST --http2-prior-knowledge --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:32703:10.63.142.199" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:31267//nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' -k --cert /certs/K6.crt --key /certs/K6.key
## 
## ## Restore
## #switch to NON-TLS for curl
## seppUnsetTLS


! Can be scipped, if no time

########################################
# UC3: SEPP - Re-selection within a Set #
########################################

5min

----
UBUNTU:
sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
----

# 3gpp-Sbi-target-apiRoot: http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org
# +
# 3gpp-Sbi-Discovery-nf-set-id: set2.udmset.5gc.mnc072.mcc262

Preparation:
while true; do sh ~/demo/sepp_demo/regUDM4_set2; sh ~/demo/sepp_demo/regUDM5_set2; sleep 50; done

export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)


# sent to Pool "Pool_NfUdm_targetapi" -> UDM4 selected 
curl -v -s --http2-prior-knowledge -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set2.udmset.5gc.mnc072.mcc262" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' | jq


# sent to Pool "Pool_NfUdm_targetapi" -> UDM5 selected 
curl -v -s --http2-prior-knowledge -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set2.udmset.5gc.mnc072.mcc262" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm5.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' | jq


Add disturbance on UDM4, SEPPsim-p4
- - - - - - - - - - - - - - - - - - 
seppAddSeppsimDisturbance 4

## export MONITOR_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sc-monitor)
## 
## #curl -X GET "http://$NODE_IP:$MONITOR_PORT/monitor/api/v0/commands?target=eric-seppsim-p4&command=config" | jq
## 
## curl -X PUT "http://$NODE_IP:$MONITOR_PORT/monitor/api/v0/commands?target=eric-seppsim-p4&command=config" -d '{"ownDomain":"region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","api":{"nudmUeContextManagement":{"disturbances":[{"status":503}]}}}' | jq
## 

Send messages again from above, now with disturbance
- - - - - - - - - - - - - - - - - - - - - - - - - - -

# sent to Pool "Pool_NfUdm_targetapi", UDM4 selected based on sepp-worker DNS lookup, 503 reply -> UDM5 selected


# sent to Pool "Pool_NfUdm_targetapi", UDM4 selected based on sepp-worker DNS lookup
curl -v -s --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access"  -H "3gpp-Sbi-Discovery-nf-set-id:set2.udmset.5gc.mnc072.mcc262" -H "3gpp-Sbi-target-apiRoot:http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' | jq

#Or 100 messages:
#curl  -v -s --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-100]"  -H "3gpp-Sbi-Discovery-nf-set-id:set2.udmset.5gc.mnc072.mcc262" -H "3gpp-Sbi-target-apiRoot:http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}'  |& grep x-origin | sort | uniq -c | prettify


#seppRemoveSeppsimDisturbances # UC4 also needs disturbance on SEPPsim-4

## #start some K6 load:
## ./loadmeter_get_seppsim_counters_udm 5 2
## 
## 
## #switch to TLS for k6
## seppSetTLS
## 
## export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
## export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
## echo $SEPP_TLS_PORT; echo $NODE_IP
## 
## k exec -it $K61_POD -- sh
## pkill k6; k6 run  -e SEPP_IP=10.63.142.199 -e SEPP_PORT=31267 -e RPS=100 -e TYPE=API -e SET=set2.udmset.5gc.mnc072.mcc262 -e APIROOT=http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org -e RAMPDURATION=1s -e HOLDDURATION=1h sepp_stability_demo_set_apiroot.js --insecure-skip-tls-verify  --no-usage-report 
## 
## ## Restore
## #switch to NON-TLS for curl
## seppUnsetTLS


########################################
# UC4:   SEPP - Routing Binding         #
########################################

# 3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org
# + 
# 3gpp-Sbi-Routing-Binding: bl=nf-set; nfset=set2.udmset.5gc.mnc072.mcc262

#export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)


# sent to Pool "Pool_NfUdm_targetapi", UDM4 selected due to target-api, 503 reply -> UDM5 selected

curl -v -s --http2-prior-knowledge -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Routing-Binding: bl=nf-set; nfset=set2.udmset.5gc.mnc072.mcc262" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' | jq

#Or 100 messages:
curl -v -s --http2-prior-knowledge -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-100]" -H "3gpp-Sbi-Routing-Binding: bl=nf-set; nfset=set2.udmset.5gc.mnc072.mcc262" -H "3gpp-Sbi-target-apiRoot:http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}'  |& grep x-origin | sort | uniq -c | prettify


++++++++++++++++++++++++++
Stop Wireshark

seppResetSeppsims

Save Wireshark
    Export Specified Package
    UC3_Re-selection_within_a_Set_UC4_Routing_Binding

Exit Wireshark
++++++++++++++++++++++++++



############################################
# UC5: SEPP - Weight based routing (static) #
############################################

5min (10min with traffic and CNOM)

!! stop UDM1/2 registration and wait 1 min before sending new registration!! 
!! Current limitation in NRFsim

----
UBUNTU:
sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
----

seppRemoveSeppsimDisturbances

#export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)


Register UDM1 without EP and capacity=30, DNS lookup is done in SEPP-Manager
------------------------------------------------------------------------------------------------------

cat << EOF > ~/demo/sepp_demo/regUDM1_set1_no_EP_30
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce100" -H "Content-Type: application/json" -d '{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce100","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"capacity": 30,"locality": "North","nfSetIdList": ["set1.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-1","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}'
EOF


#while true; do sh ~/demo/sepp_demo/regUDM1_set1_no_EP_30;  sleep 50; done


Register UDM2 with EP (IP+Port) and capacity=60  -> SEPPSIM2_POD 
---------------------------------------------------

export UDM2_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p2-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM2_set1_60
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce200" -H "Content-Type: application/json" -d '
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce200","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"capacity": 60,"locality": "North","nfSetIdList": ["set1.udmset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-2","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${UDM2_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
'
EOF

#while true; do sh ~/demo/sepp_demo/regUDM2_set1_60;  sleep 50; done

<<<<<<<<<<<<<<<<<
while true; do sh ~/demo/sepp_demo/regUDM1_set1_no_EP_30; sh ~/demo/sepp_demo/regUDM2_set1_60;  sleep 50; done
<<<<<<<<<<<<<<<<<

#in CLI as user sepp-admin, no NFs in the pools, show configuration
sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 
paginate false

show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool


#send 90 messages, show 30/60 distribution
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-90]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify

# NF      | Number of Messages
# -----------------------------
# UDM1    | 30
# UDM2    | 60


Add disturbance on UDM1, SEPPsim-p1, traffic goes to UDM2
- - - - - - - - - - - - - - - - - - - - - - - - - - - - -
seppAddSeppsimDisturbance 1

!! does NOT work anymore like this !!

## #send 90 messages, show 30/60 distribution
## curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-90]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify
## 
## # NF      | Number of Messages
## # -----------------------------
## # UDM2    | 60
## # UDM3    | 30
## 
## 
## change FOB profile
## - - - - - - - - - 
## cat ~/demo/sepp_demo/modify_FOP_2| sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 
## 
#send 90 messages, show 30/60 distribution
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-90]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify

# NF      | Number of Messages
# -----------------------------
# UDM2    | 90



Add disturbance on UDM2, SEPPsim-p2, traffic goes to UDM3
- - - - - - - - - - - - - - - - - - - - - - - - - - - - -
seppAddSeppsimDisturbance 2

#send 90 messages, show 30/60 distribution
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-90]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify

# NF      | Number of Messages
# -----------------------------
# UDM3    | 90



# If time allows
#generate some traffic if wanted and show CNOM!!

curl -s --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-100000]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' > /dev/null 



Remove disturbance on UDM
- - - - - - - - - -
seppRemoveSeppsimDisturbances

#cat ~/demo/sepp_demo/modify_FOP_1| sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 


++++++++++++++++++++++++++
Stop Wireshark

seppResetSeppsims

Save Wireshark
    Export Specified Package
    UC5_Weight_based_routing
    
Exit Wireshark  
++++++++++++++++++++++++++



########################################
# UC6:   SEPP - Sub-pool routing        # 
#              example "locality"      #
########################################

----
UBUNTU:
sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
----


Add configuration for locality in sub-pools:

cat ~/demo/sepp_demo/add_priogroup_rr | sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 

# sepp-function nf-instance sepp_instance_1
#  nf-pool NfUdm_rr_pool
#   priority-group NfUdm_rr_pg_prio1
#    priority           1
#    nf-match-condition "nfdata.locality == 'South'"
#   !
#   priority-group NfUdm_rr_pg_prio2
#    priority           2
#    nf-match-condition "nfdata.locality == 'North'"
#   !
#  !
# !
# Commit complete.

#sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 
#   
#config 
#sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool priority-group NfUdm_rr_pg_prio1 nf-match-condition "nfdata.locality == 'South'"
#sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool priority-group NfUdm_rr_pg_prio1 priority 1
#sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool priority-group NfUdm_rr_pg_prio2 nf-match-condition "nfdata.locality == 'North'"
#sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool priority-group NfUdm_rr_pg_prio2 priority 2
#show configuration
#commit
#exit
#exit


#show CLI configuration
sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 
paginate false

show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool
show running-config  sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_rr_pool


export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)

# sent to Pool "Pool_UDM_fw", UDM3 selected since locality == 'South'
curl -v -s --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' | jq

#send 90 messages, show 100% distribution to UDM3 since locality == 'South'
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-90]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify

NF  | Number of Messages
-----------------------------
UDM3    | 90


Add disturbance on UDM3, SEPPsim-p3
- - - - - - - - - - - - - - - - - - 
seppAddSeppsimDisturbance 3


#send 90 messages, show 30%/70% distribution to UDM3 since locality == 'South' is sending 503 and all traffic is sent "North"
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-90]"  -H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262"  -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' |& grep x-origin | sort | uniq -c | prettify

NF  | Number of Messages
-----------------------------
UDM1    | 30
UDM2    | 60


++++++++++++++++++++++++++
Stop Wireshark

seppResetSeppsims

Save Wireshark
    Export Specified Package
    UC6_Sub-pool_routing
    
Exit Wireshark  
++++++++++++++++++++++++++


++++++++++++++++++++++

SAVE LOG from Terminal

++++++++++++++++++++++

Remove disturbance on SEPPsim-p3 (UDM3)
---------------------------------------------------
seppRemoveSeppsimDisturbances

# === K6 ===
# 
# 
# #start some K6 load:
# ./loadmeter_get_seppsim_counters_udm 5 2
# 
# 
# #switch to TLS for k6
# seppSetTLS
# 
# export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
# export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
# echo $SEPP_TLS_PORT; echo $NODE_IP
# 
# k exec -it $K61_POD -- sh
# pkill k6; k6 run  -e SEPP_IP=10.63.142.199 -e SEPP_PORT=31267 -e RPS=100 -e SET=set1.udmset.5gc.mnc072.mcc262 -e RAMPDURATION=1s -e HOLDDURATION=1h -e TYPE=FW sepp_stability_demo_set_apiroot.js --insecure-skip-tls-verify  --no-usage-report 



# Add disturbance on UDM3, SEPPsim-p3
# - - - - - - - - - - - - - - - - - - 
# export MONITOR_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sc-monitor)
# 
# curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p3&command=config" -d '{"ownDomain":"region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","api":{"nudmUeContextManagement":{"disturbances":[{"status":503}]}}}' | jq
# 
# TODO: 20% only successful -> reason "Circuit Breaker" active, only 3 retries in parallel



RESTORE

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p&command=config" -d '{"ownDomain":"region1.udm.5gc.mnc072.mcc262.3gppnetwork.org"}' | jq

cat ~/demo/sepp_demo/remove_priogroup_rr | sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 


############################################
# UC6: SEPP as Transparent Proxy            #
############################################

# :authority header specifies the target NF (UDM1, 2 or 3)
# -> NfUDM_rr_pool


----
UBUNTU:
export SEPP_WORKER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
----

ssh -t -p $CLI_PORT sepp-admin@$NODE_IP

show running-config sepp-function nf-instance sepp_instance_1 routing-case default_routing routing-rule Send_as_transparent_proxy_to_Udm2   
   
sepp-function nf-instance sepp_instance_1
 routing-case default_routing
  routing-rule Send_as_transparent_proxy_to_Udm2
   condition "req.header[':authority'] exists and not req.header['3gpp-sbi-target-apiRoot'] exists"
   routing-action route_to_udm2
    action-route-preferred keep-authority-header
    action-route-preferred preserve-if-indirect-routing absolute-uri-path
    action-route-preferred from-authority-header
    action-route-preferred failover-profile-ref fop1
    action-route-preferred target-nf-pool nf-pool-ref NfUdm_rr_pool
   !
  !
 !
!

#alternative:
   condition "req.header[':authority'] == 'nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org'"


# sent to Pool "Pool_UDM", UDM2 selected (round robin)

curl -v -s --http2-prior-knowledge -X PUT  "http://$NODE_IP:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "Host: nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' 

# sent to Pool "Pool_UDM", UDM1 selected (round robin)

curl -v -s --http2-prior-knowledge -X PUT  "http://$NODE_IP:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "Host: nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' 

# sent to Pool "Pool_UDM", UDM3 selected (round robin)

curl -v -s --http2-prior-knowledge -X PUT  "http://$NODE_IP:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "Host: nfudm3.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"},"ratType":"NR"}' 




#################################################
# UC7: Indirect routing (Multi-Hop-SEPP routing) #
#################################################


Faults:
SEPPsim gets message with target-apiroot header and set header -> workaround, add attribute 
preserve-if-indirect-routing target-api-root-header

----
UBUNTU:
export SEPP_WORKER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
export SEPP2_WORKER_POD=$(kubectl get pods --namespace $NAMESPACE2 -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP2_WORKER_POD &
sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD &

----



cat resolv.conf
nameserver 192.168.154.141

#load DT for SEPP02
cat ~/demo/sepp_demo/config_addon_for_sepp02_udm7.txt | sshpass -p seppsepp ssh -t -p 31023 sepp-admin@$NODE_IP -s netconf


# show configuration to add, or better later in the CLI
#cat ~/demo/sepp_demo/config_addon_sepp02.txt  
cat ~/demo/sepp_demo/config_addon_sepp02.txt | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf

sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP
show running-config sepp-function nf-instance sepp_instance_1 routing-case default_routing routing-rule Send_to_ownPLMN_NfUdm_set3_pr
show running-config sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_pr_pool_set3
show running-config sepp-function nf-instance sepp_instance_1 nf-pool peer_sepp
show running-config sepp-function nf-instance sepp_instance_1 static-sepp-instance-data

#no NFs discovered in this pool:
show sepp-function nf-instance sepp_instance_1 nf-pool NfUdm_pr_pool_set3


export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)

# sent to Pool "NfUdm_pr_pool_set3", UDM7 or SEPP2 selected (strict routing)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set3.udmset.5gc.mnc072.mcc262" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm7.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' | jq

===> No health upstream 503 during demo


#DNS lookup error leads to 500 error being returned, problem on Simulator side


#Now with UDM7
while true; do sh ~/demo/sepp_demo/regUDM7_set3;  sleep 50; done


Cleanup:
cat ~/demo/sepp_demo/remove_sepp02 | sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 


############################################
# UC8: SEPP - Message Screening             #
############################################

# sent to Pool "Pool_UDM_fw", UDM1 or UDM2 selected (round robin) -> NO MODIFICATION OF THE MESSAGE YET, 3gpp-sbi-priority still present
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" \
-H "3gpp-sbi-priority:top-priority" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' | jq



    <request-screening-case>
        <name>ingress_req</name>
        <screening-rule>
            <name>ignore_priority</name>
            <screening-action>
              <name>udm_remove_priority_header</name>
              <action-remove-header>
                 <name>
                    3gpp-sbi-priority
                 </name>
              </action-remove-header>
            </screening-action>
        </screening-rule>
    </request-screening-case>
    
    
    

cat ~/demo/sepp_demo/config_addon_ms.txt | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf

sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP
show running-config sepp-function nf-instance sepp_instance_1 request-screening-case
show running-config sepp-function nf-instance own-network


# sent to Pool "Pool_UDM_fw", UDM1 or UDM2 selected (round robin)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" \
-H "3gpp-sbi-priority:top-priority" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' | jq

cat ~/demo/sepp_demo/remove_ms | sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP 

  action-add-header       Add a header to the request
  action-go-to            Jump to another request screening case
  action-log              Define log level for troubleshooting
  action-modify-header    Modify the value of a header in the request
  action-reject-message   Reject the request message with a reply message
  action-remove-header    Remove header from the request
  ---
  action-drop-message  
  action-exit-screening-case

            
            
            
Remove Header (reply) - "x-lua"
- - - - - - - - - - - - - - -

sepp-function nf-instance sepp_instance_1
 response-screening-case screen_response
  screening-rule remove_x_lua
   predicate-expression var.setid='set1.udmset.5gc.mnc072.mcc262'
   screening-action remove_x_lua_action
    action-remove-header name x-lua
   !
  !
 !
!

sepp-function nf-instance sepp_instance_1 out-response-screening-case-ref screen_response 




Remove Header (request) - "user-agent"
- - - - - - - - - - - - - - -

sepp-function nf-instance sepp_instance_1
 request-screening-case screen_request
  screening-rule remove_user_agent
   predicate-expression var.setid=='set1.udmset.5gc.mnc072.mcc262'
   screening-action remove_user_agent_action
    action-remove-header name user-agent
   !
  !
 !
!

sepp-function nf-instance sepp_instance_1 in-request-screening-case-ref screen_request







############################################
# UC9: Scaling                             #
############################################

        1. From Kubernetes dashboard, show the ease with which we can scale -> allows for super simple user experience
        2. Point out the PODs coming up on the terminal
        3. Start traffic
        4. Scale to 4 worker PODs

        VISUAL:
        CNOM:       See pods, traffic 
        Terminal 1: watch "kubectl -n $NAMESPACE get hpa"
        Terminal 2: watch "kubectl -n $NAMESPACE get pods | grep sepp-worker"

                                      
                             

0. Prepare
 

a) Stop Wireshark, stop traffic
b) filter in CNOM on "worker"

c) copy files to K6 if not already done:
export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
k cp ~/demo/sepp_demo/sepp_stability_test_set1_b.js ${K61_POD}:/tests/sepp_stability_test_set1.js
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/cert.pem ${K61_POD}:/certs/K6.crt
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/key.pem ${K61_POD}:/certs/K6.key

export K62_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[1].metadata.name}")
k cp ~/demo/sepp_demo/sepp_stability_test_set1_b.js ${K62_POD}:/tests/sepp_stability_test_set1.js
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/cert.pem ${K62_POD}:/certs/K6.crt
#k cp $GIT_PATH/5g_proto/scripts/certificates/certm_worker/keys/seppwrk/key.pem ${K62_POD}:/certs/K6.key


e)
kubectl -n $NAMESPACE delete hpa eric-sepp-worker
kubectl -n $NAMESPACE scale deploy eric-sepp-worker --replicas=1


SHOW:
kubectl -n $NAMESPACE autoscale deployment eric-sepp-worker --cpu-percent=50 --min=1 --max=4

kubectl -n $NAMESPACE get hpa

f)
watch "kubectl -n $NAMESPACE get hpa"
watch "kubectl -n $NAMESPACE get pods | grep sepp-worker"
watch "kubectl -n $NAMESPACE top pods | grep sepp-worker"



1. K6 POD traffic

export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
echo $SEPP_TLS_PORT; echo $NODE_IP

k exec -it $K61_POD -- sh

# start 1000 TPS on RR traffic, about 20% load on SEPP
k exec -it $K61_POD -- k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=$NODE_IP -e SEPP_PORT=$SEPP_TLS_PORT -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=1000 -e HOLDDURATION=600s -e RAMPDURATION=1s sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report

# start 4000 TPS on RR traffic, about 80% load on SEPP  -> 2 sepp-workers, no space for 3
k exec -it $K62_POD -- k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=$NODE_IP -e SEPP_PORT=$SEPP_TLS_PORT -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=5000 -e HOLDDURATION=600s -e RAMPDURATION=1s sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report


#pkill k6; k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=10.63.143.68 -e SEPP_PORT=31167 -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=4000 -e HOLDDURATION=600s -e RAMPDURATION=1s sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report


In case of manual scale:
k scale deployment eric-sepp-worker --replicas=3

restore
k delete hpa eric-sepp-worker



############################################
# UC10: Resilience                         #
############################################

Prerequisite:
k scale deployment eric-sepp-worker --replicas=3

export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
echo $SEPP_TLS_PORT; echo $NODE_IP


# UDM 1-3, note UDM1 will need DNS entries in sepp-manager after restart
# pkill k6; k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=10.63.143.68 -e SEPP_PORT=31167 -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=4000 -e HOLDDURATION=600s -e RAMPDURATION=1s  sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report
# 
# export SEPP_MANAGER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")
# export UDM1_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p1-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")
# 
# kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager  -- sh -c "echo ${UDM1_SVC_IP} nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"



UDM4/5
k exec -it $K61_POD -- k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=$NODE_IP -e SEPP_PORT=$SEPP_TLS_PORT -e TAPI=http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org -e SET=set2.udmset.5gc.mnc072.mcc262 -e RPS=1000 -e HOLDDURATION=1200s -e RAMPDURATION=1s  sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report


pkill k6; k6 run -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=10.63.143.68 -e SEPP_PORT=31167 -e TAPI=http://nfudm4.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org -e SET=set2.udmset.5gc.mnc072.mcc262 -e RPS=1000 -e HOLDDURATION=1200s -e RAMPDURATION=1s  sepp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report



sepp-worker restart
-----------------

        1. Mention Kubernetes feature of resilience -> we have specified that we want to always have 3 worker
                pods running -> when we kill one, another will be brought up somewhere else
        2. We are now showing a manual kill of the POD, but the same principal applies if the POD were to terminate for any other reason
        3. Show new POD up and running in seconds

        VISUAL
        CNOM:       See pods, traffic 
        Terminal 1: Showing current pods, watch "kubectl -n $NAMESPACE get pods | grep sepp-worker"
        Terminal 2: kubectl --namespace $NAMESPACE delete pod eric-sepp-worker-deployment-859c7fd79-29m95          <- Get id from the above printout

k get pods |grep sepp-worker
k delete pod <sepp-worker>   #  --grace-period=0 --force


sepp-manager restart
-------------------

        1. Mention Kubernetes feature of resilience -> we have specified that we want to always have four worker
                pods running -> when we kill one, another will be brought up somewhere else
        2. We are now showing a manual kill of the POD, but the same principal applies if the POD were to terminate for any other reason
        3. Show new POD up and running in seconds

        VISUAL
        CNOM:       See pods, traffic 
        Terminal 1: Showing current pods, watch "kubectl -n $NAMESPACE get pods | grep sepp-manager"
        Terminal 2: kubectl --namespace $NAMESPACE delete pod eric-sepp-manager-7744fd6f78-nqxk4         <- Get id from the above printout

k get pods |grep sepp-manager
k delete pod <sepp-manager>   #  --grace-period=0 --force

sepp-manager + sepp-worker restart
--------------------------------

k delete pod <sepp-manager>   <sepp-worker>   #  --grace-period=0 --force

-> New sepp-worker restarts 1x since no connection to manager



############################################
# UC11: SEPP - RP to local traffic         #
############################################

----
UBUNTU:


echo "#PODs" > ~/.config/wireshark/hosts
kubectl get pods -A -o=custom-columns=:.status.podIP,:.metadata.name >> ~/.config/wireshark/hosts
echo "#SVCs" >> ~/.config/wireshark/hosts
kubectl get svc -A  -o=custom-columns=:.spec.clusterIP,:.metadata.name | grep -v None >> ~/.config/wireshark/hosts
echo "#NODESs" >> ~/.config/wireshark/hosts
kubectl get nodes   -o=custom-columns=:.status.addresses[0].address,:.metadata.name >> ~/.config/wireshark/hosts
echo "#VDI" >> ~/.config/wireshark/hosts
echo "137.58.207.197    AMF" >> ~/.config/wireshark/hosts
echo "192.168.130.0     AMF" >> ~/.config/wireshark/hosts

sed -i -E 's/eric-seppsim-p1\S+/UDM1-DE/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p2\S+/UDM2-DE/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p3\S+/AMF-DE/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p4\S+/UDM4/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p5\S+/UDM5/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p6\S+/SEPP2/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p7\S+/SEPP-BE/' ~/.config/wireshark/hosts
sed -i -E 's/eric-seppsim-p8\S+/SEPP-SE/' ~/.config/wireshark/hosts

#add the SEPPsim service IP addresses as color filters in Wireshark:
sudo ~/seppsim2color.pl

export SEPP_WORKER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

#sudo ./kubectl-sniff -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
cat /usr/bin/tar | k exec -i $SEPP_WORKER_POD -c eric-sepp-worker -- tee /usr/bin/tar >/dev/null
k exec -i $SEPP_WORKER_POD -c eric-sepp-worker -- chmod a+x /usr/bin/tar
/proj/sc-tools/share/ksniff/kubectl-sniff  -c eric-sepp-worker -n $NAMESPACE $SEPP_WORKER_POD
----

function curlRPBE ()
{
        echo "Sending CURL - IMSI: $1 - $2"
        export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
        export NODE_IP=$(kubectl get nodes --namespace 5g-bsf-$USER -o jsonpath="{.items[3].status.addresses[0].address}")
        curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-${1}/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key 2>&1 |grep -v "TLS" |  jq  
}

function curlRPBEnon ()
{
        echo "Sending CURL - IMSI: $1 - $2"
        export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
        export NODE_IP=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
        curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key | jq

}



configuration_sepp_demo_sc1.5.xml

cat ~/configuration_sepp_demo_sc1.5.xml| sshpass -p  seppsepp ssh sepp-admin@$NODE_IP -p $YP_PORT

cd ~/demo/sepp_demo


#Create Root Key
openssl ecparam -name prime256v1 -genkey -noout -out rootCA_RPBE-key.pem
openssl ecparam -name prime256v1 -genkey -noout -out rootCA_RPSE-key.pem
openssl ecparam -name prime256v1 -genkey -noout -out rootCA_RPDK-key.pem
openssl ecparam -name prime256v1 -genkey -noout -out rootCA_own-key.pem

openssl genrsa -out rootCA_RPBE.key 4096 
openssl genrsa -out rootCA_RPSE.key 4096 
openssl genrsa -out rootCA_RPDK.key 4096 
openssl genrsa -out rootCA_own.key 4096 

#Create and self sign the Root Certificate for 3 years
openssl req -x509 \
   -new \
   -nodes \
   -key rootCA_RPBE-key.pem \
   -sha256 \
   -days 1095 \
   -out rootCA_RPBE-cert.pem \
   -config <(printf "[req] \ndistinguished_name = dn \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = ca_rp_be\n") 

openssl req -x509 \
   -new \
   -nodes \
   -key rootCA_RPSE-key.pem \
   -sha256 \
   -days 1095 \
   -out rootCA_RPSE-cert.pem \
   -config <(printf "[req] \ndistinguished_name = dn \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = ca_rp_se\n") 

openssl req -x509 \
   -new \
   -nodes \
   -key rootCA_RPDK-key.pem \
   -sha256 \
   -days 1095 \
   -out rootCA_RPDK-cert.pem \
   -config <(printf "[req] \ndistinguished_name = dn \nprompt = no \n\n[dn] \nC = DK \nL = Kopenhagen \nO = Ericsson \nCN = ca_rp_dk\n") 


openssl req -x509 \
   -new \
   -nodes \
   -key rootCA_own-key.pem \
   -sha256 \
   -days 1095 \
   -out rootCA_own-cert.pem \
   -config <(printf "[req] \ndistinguished_name = dn \nprompt = no \n\n[dn] \nC = DE \nL = Berlin \nO = Ericsson \nCN = ca_own\n") 



--- RP BE ---
#*.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org\n


openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_206033-key.pem \
    -out RP_206033-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_206033-csr.pem \
    -CA rootCA_RPBE-cert.pem \
    -CAkey rootCA_RPBE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_206033-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org\n") 



openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_206033-sepp-key.pem \
    -out RP_206033-sepp-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_206033-sepp-csr.pem \
    -CA rootCA_RPBE-cert.pem \
    -CAkey rootCA_RPBE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_206033-sepp-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org\n")



#nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org

openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_206033_1-key.pem \
    -out RP_206033_1-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_206033_1-csr.pem \
    -CA rootCA_RPBE-cert.pem \
    -CAkey rootCA_RPBE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_206033_1-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = BE \nL = Brussels \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org\n") 

--- RP SE ---
Ericsson SE: MCC 240    MNC 060

openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_240060-key.pem \
    -out RP_240060-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_240060-csr.pem \
    -CA rootCA_RPSE-cert.pem \
    -CAkey rootCA_RPSE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_240060-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org\n") 



openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_240060-sepp-key.pem \
    -out RP_240060-sepp-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_240060-sepp-csr.pem \
    -CA rootCA_RPSE-cert.pem \
    -CAkey rootCA_RPSE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_240060-sepp-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org\n") 

--NEW--

openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_240060-sepp-key2.pem \
    -out RP_240060-sepp-csr2.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org\nDNS.2 = sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_240060-sepp-csr2.pem \
    -CA rootCA_RPSE-cert.pem \
    -CAkey rootCA_RPSE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_240060-sepp-cert2.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org\nDNS.2 = sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org\n") 


--- DK ---
Ericsson DK: MCC 238    MNC 040

openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_238040-key.pem \
    -out RP_238040-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = DK \nL = Kopenhagen \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc040.mcc238.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.amf.5gc.mnc040.mcc238.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_238040-csr.pem \
    -CA rootCA_RPDK-cert.pem \
    -CAkey rootCA_RPDK-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_238040-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = DK \nL = Kopenhagen \nO = Ericsson \nCN = nfamf.region1.amf.5gc.mnc040.mcc238.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.amf.5gc.mnc040.mcc238.3gppnetwork.org\n") 

--- own ---


Ericsson DE: MCC 262    MNC 072

openssl req -nodes \
    -newkey rsa:2048 \
    -keyout own_traffic-key.pem \
    -out own_traffic-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = DE \nL = Berlin \nO = Ericsson \nCN = nfudm.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org\n") 

openssl x509 -req \
    -in own_traffic-csr.pem \
    -CA rootCA_DE-cert.pem \
    -CAkey rootCA_DE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out own_traffic-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = DE \nL = Berlin \nO = Ericsson \nCN = nfudm.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org\n") 


openssl req -nodes \
    -newkey rsa:2048 \
    -keyout RP_262072-sepp-key.pem \
    -out RP_262072-sepp-csr.pem \
    -config <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org\n") 

openssl x509 -req \
    -in RP_262072-sepp-csr.pem \
    -CA rootCA_DE-cert.pem \
    -CAkey rootCA_DE-key.pem \
    -CAcreateserial \
    -days 365 \
    -out RP_262072-sepp-cert.pem \
    -extensions 'v3_req' \
    -extfile <(printf "[req] \ndistinguished_name = dn \nx509_extensions = v3_req \nreq_extensions = v3_req \nprompt = no \n\n[dn] \nC = SE \nL = Stockholm \nO = Ericsson \nCN = sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org \n\n[v3_req] \nsubjectAltName = @alt_names \n\n[alt_names] \nDNS.1 = *.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org\n") 

--------------

openssl x509 -in  RP_206033-cert.pem -text  | grep DNS      #SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org
openssl x509 -in  RP_206033_1-cert.pem -text | grep DNS     #SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org
openssl x509 -in  RP_240060-cert.pem -text | grep DNS       #SAN: *.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org
openssl x509 -in  RP_238040-cert.pem -text | grep DNS       #SAN: *.region1.amf.5gc.mnc040.mcc238.3gppnetwork.org

openssl verify -CAfile rootCA_RPBE-cert.pem  RP_206033-cert.pem
openssl verify -CAfile rootCA_RPSE-cert.pem  RP_240060-cert.pem

#load rootCA_own-cert.pem to the list of rootCAs in sc-traf-root-ca-list1 
base64 -w 0 rootCA_own-cert.pem    

truststore certificates sc-traf-root-ca-list1 install-certificate-pem name C=DE_L=Berlin_O=Ericsson_CN=ca_own_valid_20251116 pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkVENDQVJvQ0NRQzc5K3ZURFROc1VUQUtCZ2dxaGtqT1BRUURBakJDTVFzd0NRWURWUVFHRXdKRVJURVAKTUEwR0ExVUVCd3dHUW1WeWJHbHVNUkV3RHdZRFZRUUtEQWhGY21samMzTnZiakVQTUEwR0ExVUVBd3dHWTJGZgpiM2R1TUI0WERUSXlNVEV4TnpFMk1EWTBNbG9YRFRJMU1URXhOakUyTURZME1sb3dRakVMTUFrR0ExVUVCaE1DClJFVXhEekFOQmdOVkJBY01Ca0psY214cGJqRVJNQThHQTFVRUNnd0lSWEpwWTNOemIyNHhEekFOQmdOVkJBTU0KQm1OaFgyOTNiakJaTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEEwSUFCTTFOUkFPOE4vcmNsOXlPaVZDZAo0Vnd3N0U4NjgzNWFNTU1FUHhRVjJnMlcwcFBZTjJLM3B6UW10THRleEV3TGxjVW9jNExQeGhmM0U5eXZWVVFXCnVwTXdDZ1lJS29aSXpqMEVBd0lEU1FBd1JnSWhBUDYxVHpkRWdGQTVKUXZUWkliQTZuNktPZnVhanBlb2FPVEYKY0xHZzBOSXVBaUVBc0lXUVEvQzdVUkhWNlF1WWM0VmhqaFUwRlVVVUViTGx1djJkZlJzWFlKYz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=

The rootCA_own ends up in the secret sc-traf-root-ca-list1-secret
This secret is mounted by eric-sepp-worker/eric-sepp-sds and eric-sepp-worker/eric-sepp-cert-notifier
in /root/certificates/ca/sc-traf-root-ca-list1/cert1.pem
(and /root/certificates/ca/sc-traf-root-ca-list2/cert1.pem)

It ends up in Envoy config
export SEPP_POD=$(kubectl get pods -n $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/config_dump?include_eds"  | grep CERTIFICATE -B 3

Wait 1 minute max!!


Store PR_BE and RP_SE CAs in truststore
base64 -w 0 rootCA_RPBE-cert.pem    

truststore certificates sc-traf-root-ca-list2 install-certificate-pem name C=BE_L=Brussels_O=Ericsson_CN=ca_rp_be_20251116 pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlekNDQVNJQ0NRQ3hTamNZMkZ3Qmp6QUtCZ2dxaGtqT1BRUURBakJHTVFzd0NRWURWUVFHRXdKQ1JURVIKTUE4R0ExVUVCd3dJUW5KMWMzTmxiSE14RVRBUEJnTlZCQW9NQ0VWeWFXTnpjMjl1TVJFd0R3WURWUVFEREFoagpZVjl5Y0Y5aVpUQWVGdzB5TWpFeE1UY3hOakEyTURoYUZ3MHlOVEV4TVRZeE5qQTJNRGhhTUVZeEN6QUpCZ05WCkJBWVRBa0pGTVJFd0R3WURWUVFIREFoQ2NuVnpjMlZzY3pFUk1BOEdBMVVFQ2d3SVJYSnBZM056YjI0eEVUQVAKQmdOVkJBTU1DR05oWDNKd1gySmxNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV4MDdTbnhZTwpqNGtLaGFpZ0ZBK2g5bUlnYityT0FwSHZ6T3JMSHlkbEZnN3ZURnFnc1RsQjRZKzhMYkZqT3JyTEtneGdGY2VGCmZLVllMcDc3THpxTHlqQUtCZ2dxaGtqT1BRUURBZ05IQURCRUFpQm9teUZyQzlLcWI3NW4yS0dYdXRDOVF4NW8KSUowSGFyc0h2RXlGc1k1czNRSWdYTmkvTE5JNDBlYjducWpvZ21sNG5RSVpuUnhKQ1BFNlQxVUZFeFFrU2dNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==


base64 -w 0 rootCA_RPSE-cert.pem    

truststore certificates sc-traf-root-ca-list2 install-certificate-pem name C=SE_L=Stockholm,_O=Ericsson_CN=ca_rp_se_20251116 pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmVENDQVNRQ0NRQ0xUOWJQUThqZm1EQUtCZ2dxaGtqT1BRUURBakJITVFzd0NRWURWUVFHRXdKVFJURVMKTUJBR0ExVUVCd3dKVTNSdlkydG9iMnh0TVJFd0R3WURWUVFLREFoRmNtbGpjM052YmpFUk1BOEdBMVVFQXd3SQpZMkZmY25CZmMyVXdIaGNOTWpJeE1URTNNVFl3TmpReVdoY05NalV4TVRFMk1UWXdOalF5V2pCSE1Rc3dDUVlEClZRUUdFd0pUUlRFU01CQUdBMVVFQnd3SlUzUnZZMnRvYjJ4dE1SRXdEd1lEVlFRS0RBaEZjbWxqYzNOdmJqRVIKTUE4R0ExVUVBd3dJWTJGZmNuQmZjMlV3V1RBVEJnY3Foa2pPUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVRGald5NAo0QjhRR2ZaVFpwR3lqdVZNQjd3UTJVN2V1V1RKZFFpdjJybnBvS2ROLzhoNU1PaVc5S01FM3VqYjRHYjdNMTg3Cks1bm9Ua05tclFOYitLRG1NQW9HQ0NxR1NNNDlCQU1DQTBjQU1FUUNJQjlsRVN0QVM2U3VNSHIrT0xWT0JMNTYKUHhnck5vTUkrK0NMNE4xNUxYcjZBaUFSbzBxZXRsU1NaM3lXak93U2hMektSZGlqVGU4ZnJvTDVMajZJOEUregplZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K

# own traffic certificates

...


-----------------

SHOW CONFIGURATION
ssh -p $CLI_PORT sepp-admin@$NODE_IP

paginate false 
show running-config sepp-function 


# c) copy files to K6 if not already done:
# chmod 0644 ~/demo/sepp_demo/*.key
# 
# 
# export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
# k cp ~/demo/sepp_demo/sepp_demo_test.js ${K61_POD}:/tests/sepp_demo_test.js
# k cp ~/demo/sepp_demo/certificates/RP_206033-cert.pem ${K61_POD}:/certs/RP_206033.crt
# k cp ~/demo/sepp_demo/certificates/RP_206033-key.pem ${K61_POD}:/certs/RP_206033.key
# k cp ~/demo/sepp_demo/certificates/RP_206033-cert.pem ${K61_POD}:/certs/RP_206033_1.crt
# k cp ~/demo/sepp_demo/certificates/RP_206033-key.pem ${K61_POD}:/certs/RP_206033_1.key
# 
# export K62_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[1].metadata.name}")
# k cp ~/demo/scp_demo/scp_stability_test_set1_b.js ${K62_POD}:/tests/scp_stability_test_set1.js
# k cp ~/demo/sepp_demo/RP_240060.crt ${K62_POD}:/certs/RP_240060.crt
# k cp ~/demo/sepp_demo/RP_240060.key ${K62_POD}:/certs/RP_240060.key

export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

k exec -it $K61_POD -- k6 run -e CERT=RP_206033.crt -e KEY=RP_206033.key -e RPS=400 -e DURATION=60s -e MAX_VUS=40 -e SEPP_IP=$NODE_IP -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_PORT=$SEPP_TLS_PORT -e TAR=http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org sepp_demo_test.js --insecure-skip-tls-verify  --no-usage-report


k exec -it $K62_POD -- k6 run -e CERT=RP_240060.crt -e KEY=RP_240060.key -e RPS=400 -e DURATION=60s -e MAX_VUS=40 -e SEPP_IP=$NODE_IP -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_PORT=$SEPP_TLS_PORT -e TAR=http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org sepp_demo_test.js --insecure-skip-tls-verify  --no-usage-report


export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)
export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

# sent from RP_BE  (SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/certificates/RP_206033-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-key.pem  2>&1 | grep '^[<>]'



# sent from RP_BE  (SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)  
# (via SEPP-BE) to SEPP-DE (SUT) and then forwarded to UDM-DE
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033_1.crt --key ~/demo/sepp_demo/RP_206033_1.key  2>&1 | grep '^[<>]'


# sent from RP_SE (SAN: *.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org)
# (via SEPP-SE) to SEPP-DE (SUT) and then forwarded to UDM-DE
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org", "guami":{"plmnId":{"mcc":"240","mnc":"060"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_240060.crt --key ~/demo/sepp_demo/RP_240060.key  2>&1 | grep '^[<>]'

## OWN Showcase !!
##################

k exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/stats" | grep ssl.fail

# sent from RP_DK (SAN: *.region1.amf.5gc.mnc040.mcc2380.3gppnetwork.org Domain-name: -) -> Certificate Unknown
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc040.mcc238.3gppnetwork.org", "guami":{"plmnId":{"mcc":"238","mnc":"040"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_238040.crt --key ~/demo/sepp_demo/RP_238040.key 

ssh -p $CLI_PORT expert@$NODE_IP
metrics-query envoy_listener_ssl_fail_verify_san




##  send 100 messages from RP-BE
curl -s --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP"  \
"https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access?a=[1-10000]" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key

##  curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access?a=[1-100]" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_240060.crt --key ~/demo/sepp_demo/RP_240060.key |& grep x-origin | sort | uniq -c | prettify
##  
##  SAN: *.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.5gc.mnc033.mcc206.3gppnetwork.org)                                     -> OK
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)     -> OK
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.5gc.mnc033.mcc206.3gppnetwork.org)                     -> alert certificate unknown, should work according to UG
##  SAN: *.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)                     -> alert certificate unknown, should work according to UG
##  SAN: *.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *gc.mnc033.mcc206.3gppnetwork.org)                                       -> alert certificate unknown
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org *gc.mnc033.mcc206.3gppnetwork.org)                                    -> alert certificate unknown
##  SAN: *.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: nfamf*.5gc.mnc033.mcc206.3gppnetwork.org)                                -> alert certificate unknown, should work according to UG
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: nfamf*.5gc.mnc033.mcc206.3gppnetwork.org)                -> alert certificate unknown, should work according to UG
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: nfamf.*.5gc.mnc033.mcc206.3gppnetwork.org)               -> rejected at config time by yang validation
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *amf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)      -> OK
##  SAN: *.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *amf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)                      -> alert certificate unknown
##  
##  SAN: nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)         -> OK
##  


Counters per RP:
envoy_ingress_downstream_rq_xx_per_roaming_partner
envoy_ingress_downstream_rq_xx_per_roaming_partner_per_instance
envoy_ingress_downstream_rq_total_per_roaming_partner
envoy_ingress_downstream_rq_total_per_roaming_partner_per_instance

rate(envoy_downstream_rq_xx{envoy_response_code_class='2',roaming_partner=~".+"}[10s])

{envoy_response_code_class="2", group="ingress", instance="192.168.130.49:9901", job="eric-sepp-worker", nf_instance="instance_1", nf_type="sepp", roaming_partner="RP_SE"}

rate(envoy_downstream_rq_total{roaming_partner=~".+"}[10s])
{group="ingress", instance="192.168.130.49:9901", job="eric-sepp-worker", nf_instance="instance_1", nf_type="sepp", roaming_partner="RP_SE"}


############################################
# UC12: SEPP - local traffic to RP         #
############################################

kubectl --namespace $NAMESPACE scale deploy eric-sc-monitor --replicas=1

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?command=list" |jq


Set Own Domain for SEPPsim
---------------------------
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc072.mcc262.3gppnetwork.org"}' | jq

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org"}' | jq

export SEPPSIMP7_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p7-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
echo $SEPPSIMP7_SVC_IP
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","ownIpAddress": "127.0.0.1"}' | jq

export SEPPSIMP8_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p8-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
echo $SEPPSIMP8_SVC_IP
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p8&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc060.mcc240.3gppnetwork.org","ownIpAddress": "127.0.0.1"}' | jq

#Verify DNS entries in SEPP-Manager
kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager -- cat /etc/hosts

export SEPP_INT_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)
export SEPP_INT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)

#export EDITOR=vi
#k edit deploy eric-seppsim-p7 -o yaml

# export UDM3_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p3-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
# echo $UDM3_SVC_IP
# 
# nfudm3.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org


# sent from internal via SEPP-DE (SUT) to RP_BE using HTTP (HTTPS not working yet with Seppsim)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT/nudm-uecm/v1/imsi-2060330007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' 

# sent from internal via SEPP-DE (SUT) to RP_SE using HTTP (HTTPS not working yet with Seppsim)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT/nudm-uecm/v1/imsi-2400600007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm-se.region1.udm.5gc.mnc060.mcc240.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' 


# sent from internal via SEPP-DE (SUT) to RP_DK using HTTP  -> 404 Not found from SEPP
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT/nudm-uecm/v1/imsi-2380400007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm-dk.region1.udm.5gc.mnc040.mcc238.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' 

in SC 1.8: 400
{"cause":"UNSPECIFIED_MSG_FAILURE","title":"Bad request","status":"400","detail":"direct_response"}
??? Why
No more rules in filter-case: routing_from_internal


############################################
# UC12b: local traffic to RP (SEPP)        #
#        using Telescopic FQDN (T-FQDN)    #
############################################



1) 1st message is discovery request from vAMF via vNRF-hNRF to hUDM
------------------------------------------------------------------------


0. Preparations
#Register UDM_BE with EP (IP+Port) in vNRF (BE)  -> SEPPSIM2_POD

export UDM_BE=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p2-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regUDM_BE
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce200" -H "Content-Type: application/json" -d '
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce200","nfType": "UDM","nfStatus": "REGISTERED","fqdn":"nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","priority": 1,"capacity": 100,"locality": "North","nfSetIdList": ["set1.udmset.5gc.mnc033.mcc206"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1","serviceName": "nudm-uecm","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1-be.0"}],"ipEndPoints": [{"ipv4Address": "${UDM_BE}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
'
EOF

while true; do sh ~/demo/sepp_demo/regUDM_BE;  sleep 50; done

#Prepare vSEPPsim to send messages to vNRF   !!!!
export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "5gc.mnc033.mcc206.3gppnetwork.org","ownIpAddress": "10.63.143.71"}' | jq
#$NODE_IP is added here, NOTE, normally 127.0.0.1 is used as ownIpAddress

export SEPP_INT_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker-2)


# 1. configure TFQDN handling for discovery
# done already
ssh sepp-admin@$NODE_IP -p $CLI_PORT
config
sepp-function nf-instance instance_1 telescopic-fqdn required-for-nf-type [ amf ]
commit
end
exit

# inbound roamer
# 2. send discovery request from (AMF-DE and) NRF-DE via SEPP-DE (via SEPP-BE) to NRF-BE
curl  -v --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT:$NODE_IP"  "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT/nnrf-disc/v1/nf-instances?requester-nf-type=AMF&target-nf-type=UDM"  -H "3gpp-Sbi-Target-Apiroot: http://nrfsim.region1.nrf.5gc.mnc033.mcc206.3gppnetwork.org:$NRFSIM_PORT" -X GET --http2-prior-knowledge -H "Connection: keep-alive" -H "Content-Type: application/json" -H "Accept: application/json"   | jq

200
..
{
  "nfInstances": [
    {
      "capacity": 100,
      "fqdn": "NZTHKZDNFVRGKLTSMVTWS33OGEXHKZDNFY2WOYZONVXGGMBTGMXG2Y3DGIYDMLRTM5YHA3TFOR3W64TLFZXXEZY.sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org",


2) 2nd message is service request from vAMF-DE via cSEPP (SUT) - pSEPP to hUDM-BE
----------------------------------------------------------------------------------

0) Prerequisite !!!!!!!!!!!!!

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","ownIpAddress": "127.0.0.1"}' | jq


1) call from vAMF to hUDM_BE
#eedcsi@seroiuvd05256[17:37][git/5g_proto/esc]$ cat  | base32 -d 
#NZTHKZDNFVRGKLTSMVTWS33OGEXHKZDNFY2WOYZONVXGGMBTGMXG2Y3DGIYDMLRTM5YHA3TFOR3W64TLFZXXEZY
#nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org
#nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org

# sent from internal to RP_BE using HTTP (HTTPS not working yet with Seppsim)
# NZTHKZDNFVRGKLTSMVTWS33OGEXHKZDNFY2WOYZONVXGGMBTGMXG2Y3DGIYDMLRTM5YHA3TFOR3W64TLFZXXEZY ->  nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org
# seppsim-p7

curl -v --http2-prior-knowledge  -X PUT --resolve "NZTHKZDNFVRGKLTSMVTWS33OGEXHKZDNFY2WOYZONVXGGMBTGMXG2Y3DGIYDMLRTM5YHA3TFOR3W64TLFZXXEZY.sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT:$NODE_IP" "http://NZTHKZDNFVRGKLTSMVTWS33OGEXHKZDNFY2WOYZONVXGGMBTGMXG2Y3DGIYDMLRTM5YHA3TFOR3W64TLFZXXEZY.sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT/nudm-uecm/v1/imsi-2060330007487/registrations/amf-3gpp-access" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}'  | jq

look at Location Header in Wireshark or CURL output


3) Subscription with CallbackUri from hUDM-BE via cSEPP-BE - pSEPP-DE(SUT) to vAMF-DE (needs TFQDN)
----------------------------------------------------------------------------------------------------

curl -v --http2-prior-knowledge  -X POST --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT:$NODE_IP"  "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_TLS_PORT/namf-comm/v1/ue-contexts/imsi-2060330007487/n1-n2-messages/subscriptions" -H "3gpp-Sbi-target-apiRoot:http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"n2InformationClass":"SM","n2NotifyCallbackUri":"http://nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","n1MessageClass":"5GMM","n1NotifyCallbackUri":"http://nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","nfId":"123e4567-e89b-12d3-a456-426614174000","supportedFeatures":"599E51", "guami":{"plmnId":{"mcc":"033","mnc":"206"},"amfId":"Fc4E30"}}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key

SHOW IN Wireshark request that is received by seppsim-p3 (AMF-DE)


----

curl -k http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:30783/nnrf-disc/v1/nf-instances?requester-nf-type=AMF&target-nf-type=UDM  -H "3gpp-Sbi-Target-Apiroot: http://nrfsim.region1.nrf.5gc.mnc033.mcc206.3gppnetwork.org:30056" -X GET --http2-prior-knowledge -H "Connection: keep-alive" -H "Content-Type: application/json" -H "Accept: application/json"  | jq


curl --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP"  "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nnrf-disc/v1/nf-instances?requester-nf-type=AMF&target-nf-type=UDM"  -H "3gpp-Sbi-Target-Apiroot: http://nrf.region1.nrf.5gc.mnc033.mcc206.3gppnetwork.org:$NRFSIM_PORT" -X GET --http2-prior-knowledge -H "Connection: keep-alive" -H "Content-Type: application/json" -H "Accept: application/json"  | jq

#curl -k https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:30783/nnrf-disc/v1/nf-instances?requester-nf-type=AMF&target-nf-type=UDM --cert /certs/K6.crt --key /certs/K6.key -H "3gpp-Sbi-Target-Apiroot: http://nrfsim.5gc.mnc033.mcc206.3gppnetwork.org:30056" -X GET --http2-prior-knowledge -H "Connection: keep-alive" -H "Content-Type: application/json" -H "Accept: application/json"  | jq


      hostAliases:
      - hostnames:
        - nfudm3.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org
        ip: 10.103.21.112
        - nrfsim.region1.nrf.5gc.mnc033.mcc206.3gppnetwork.org
        ip: 10.107.46.223




########################################################################################
# NEW UC: interoperability between SEPPs that don't support TaR                        #
########################################################################################



Message is service request from vAMF-DE via cSEPP (SUT) - pSEPP (not supporting TaR) to hUDM-BE
------------------------------------------------------------------------------------------------

0) Prerequisite !!!!!!!!!!!!!

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p7&command=config" -d '{"ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org","ownIpAddress": "127.0.0.1"}' | jq

export SEPP_INT_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker-2)


1) configure RP

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_BE supports-target-apiroot false 



2) call from vAMF to hUDM_BE


curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT:$NODE_IP" "http://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_INT_PORT/nudm-uecm/v1/imsi-2060330007487/registrations/amf-3gpp-access"  -H "3gpp-Sbi-Target-Apiroot: nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}'  | jq

look at :authority in Wireshark in messages sent to pSEPP

############################################
# UC14: SEPP - Topology Hiding (SEPP1.7)   #
#        - Pseudo Profile                  #
############################################

#Load addon-configuration:
#~/bin/update_sepp_config.pl -f ~/demo/sepp_demo/addon_th_nr.xml -t $NAMESPACETOOLS
#cat ~/sepp_sample_config.xml | ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf

cat ~/demo/sepp_demo/addon_th.xml | ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf

#Explain the configuration load
ssh -p $CLI_PORT sepp-admin@$NODE_IP

echo "show running-config sepp-function nf-instance topology-hiding" | sshpass -p seppsepp ssh -p $CLI_PORT sepp-admin@$NODE_IP
echo "show running-config sepp-function nf-instance external-network roaming-partner RP_BE" | sshpass -p seppsepp ssh -p $CLI_PORT sepp-admin@$NODE_IP
echo "show running-config sepp-function nf-instance routing-case routing-rule Send_TH_traffic_to_ownPLMN_NfUdm" | sshpass -p seppsepp ssh -p $CLI_PORT sepp-admin@$NODE_IP


export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)


# send a NF DISCOVERY request that is directly answered by the SEPP with a configured answer FQDN

curl -v --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" --http2-prior-knowledge -X GET "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nnrf-disc/v1/nf-instances?requester-nf-type=AMF&target-nf-type=UDM" --cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem    | jq

< HTTP/2 200 
< content-type: application/json
< content-length: 158
< date: Thu, 12 May 2022 11:33:25 GMT
< server: sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org
< 
* Connection #0 to host sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org left intact
{
	"validityPeriod": 60,
	"nfInstances": [
		{
			"nfInstanceId": "a0e37036-b5fc-4fee-a683-a8e80c714ed1",
			"nfType": "UDM",
			"nfStatus": "REGISTERED",
			"fqdn": "udm-th.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org"
		}
	]
}


# sent from RP_BE  (SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org) to the TH FQDN received earlier

curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://udm-th.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' --cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem    | jq


#NOTE: TAR location is changed to the TH FQDN

#Restoration
cat ~/demo/sepp_demo/addon_removal_th.xml | ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf



############################################
# UC15: SEPP - Topology Hiding (SEPP1.11)  #
#        - IP Address Hiding               #
############################################


The pSEPP shall perform topology hiding on connections to roaming partners by limiting the internal topology information visible to external parties.

pSEPP shall hide IP address information in Nnrf responses and notifications provided to roaming partners.

pSEPP shall apply the IP address hiding on the N27 interface (vNRF  hNRF)

IPv4 and IPv6 addresses shall be removed from NF profiles and services in Nnrf response and notification messages if corresponding FQDNs (FQDN or interPlmnFqdn) at the NF profile level are included.

If a notification message just carries profile change information and the NF type is not included, IPv4 and IPv6 addresses shall be hidden if IP Address hiding shall be applied on NF profile changes and if the IPv4 and IPv6 addresses belong to an IP subnet where IP address hiding shall be applied.

The operator shall be able to turn on/off the TPH IP Hiding functionality based on the targeted NF type or all NF types.

The level of granularity of the configuration shall be on external network and roaming partner levels (the latter overwrites the former) 

The operator shall be able to turn on/off the TPH IP hiding functionality for notification messages carrying NF profile changes not indicating the NF type. 

The operator shall be able to configure a list of IPv4 and IPv6 sub-networks where TPH IP hiding functionality for notification messages carrying profile changes not indicating the NF type shall be performed.

The operator shall be able to define the action that should be taken whenever an NF profile or service with no FQDN is received by the pSEPP from the pNRF. The options for the actions shall be: apply IP hiding, drop message, forward as is and reject for both the Nnrf_NFDiscovery discovery responses and Nnrf_NFManagement notifications. In case of rejection, the status, title, cause and detail attributes shall be configured by the operator. 

In case the pNRF has responded with an HTTP/2 error message, the pSEPP shall forward the response without applying the IP hiding functionality.

Appropriate counters and KPIs shall be supported for counting the number of responses and notifications that are modified with regards to IP topology hiding.

Appropriate counters and KPIs shall be supported for the case in which the FQDN is not present in an NF profile for which the IP hiding is enabled.

IP hiding profile and Pseudo profile handling are mutually exclusive for the same NF type and the same roaming partner.

sepp-function nf-instance instance_1
 static-nf-instance-data nrf_static
  static-nf-instance nrfsim
   nf-type    nrf
   scp-domain [ "" ]
   static-nf-service nnrf-nfm
    capacity 10
    priority 10
    set-id   [ "" ]
    address scheme http
    address fqdn eric-nrfsim
   !
  !
 !

sepp-function nf-instance instance_1
 nf-pool nrf_pool
  own-network-ref internalNetwork
  nf-pool-discovery nrf_pool_discovery
   static-nf-instance-data-ref [ nrf_static ]
   update-interval             1h
  !
 !
 
sepp-function nf-instance instance_1
 message-data extract_protocol
  path
  extractor-regex "/(?P<proto>[^/]+)/(?P<version>v\d+)/"

sepp-function nf-instance instance_1
 routing-case routing_from_external
  message-data-ref [ extract_protocol ]
  routing-rule external_to_nrf_rr
   condition var.proto=='nnrf-disc'
   routing-action to_nrf
    action-route-round-robin failover-profile-ref fob1
    action-route-round-robin target-nf-pool nf-pool-ref nrf_pool
   !
  !


sepp-function nf-instance instance_1
 topology-hiding amf_th_ip
  condition target-nf-type=='AMF'
  ip-address-hiding on-fqdn-absence respond-with-error status 400
  ip-address-hiding on-fqdn-absence respond-with-error title IP_ADDRESS_HIDING_ERROR
  ip-address-hiding on-fqdn-absence respond-with-error cause UNSPECIFIED_MSG_FAILURE
  ip-address-hiding on-fqdn-absence respond-with-error detail "The request cannot be answered, since no FQDN is present"
  ip-address-hiding on-fqdn-absence respond-with-error format json
  ip-address-hiding on-nf-profile-absence remove-ipv4-address-range  [ 10.10.10.0/24 ]
  !
 topology-hiding udm_th_ip
  condition target-nf-type=='UDM'
  ip-address-hiding on-fqdn-absence forward-message
  ip-address-hiding on-nf-profile-absence remove-ipv4-address-range [ 10.10.11.0/24 ]

sepp-function nf-instance instance_1
 external-network externalNetwork
  roaming-partner RP_BE
   topology-hiding-ref      [ amf_th_ip udm_th_ip ]

curl -X GET "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/"$1"" | jq


#register AMF in NRF
export NRFSIM_PORT=$(kubectl get --namespace $NAMESPACE  -o jsonpath="{.spec.ports[0].nodePort}" services eric-nrfsim)
export NRFSIM_PORT_TLS=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-nrfsim)

Register AMF1 with EP (IP+Port) 
---------------------------------------------------

export AMF1_SVC_IP=$(kubectl get svc --namespace $NAMESPACE eric-seppsim-p -o jsonpath="{.spec.clusterIP}")

cat << EOF > ~/demo/sepp_demo/regAMF1_set1_100
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-a0735e6ce200" -H "Content-Type: application/json" -d '
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-a0735e6ce200","nfType": "AMF","nfStatus": "REGISTERED","fqdn":"nfamf1.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org","priority": 1,"capacity": 100,"locality": "North","nfSetIdList": ["set1.amfset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-2","serviceName": "namf-mt","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${AMF1_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
'
EOF

while true; do sh ~/demo/sepp_demo/regAMF1_set1_100;  sleep 50; done

cat << EOF > ~/demo/sepp_demo/regAMF1_nofqdn_100
curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-a0735e6ce200" -H "Content-Type: application/json" -d '
{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-a0735e6ce200","nfType": "AMF","nfStatus": "REGISTERED","priority": 1,"capacity": 100,"locality": "North","nfSetIdList": ["set1.amfset.5gc.mnc072.mcc262"],"nfServicePersistence": false,"nfServices": [{"serviceInstanceId": "1-2","serviceName": "namf-mt","versions": [{"apiVersionInUri": "v1","apiFullVersion": "1.0"}],"ipEndPoints": [{"ipv4Address": "${AMF1_SVC_IP}","port": 80,"transport": "TCP"}],"scheme": "http","nfServiceStatus": "REGISTERED"}]}
'
EOF
while true; do sh ~/demo/sepp_demo/regAMF1_nofqdn_100;  sleep 50; done



curl -X PUT "http://$NODE_IP:$NRFSIM_PORT/nnrf-nfm/v1/nf-instances/2ec8ac0b-265e-4165-86e9-e0735e6ce100" -H "Content-Type: application/json" -d '{"nfInstanceId":"2ec8ac0b-265e-4165-86e9-e0735e6ce100","nfType":"AMF","nfStatus":"REGISTERED","fqdn":"seppsim-p","priority":1,"nfSetIdList":["Set-1","Set-2"],"nfServicePersistence":false,"nfServices":[{"serviceInstanceId":"1","serviceName":"nchf-convergedcharging","versions":[{"apiVersionInUri":"v1","apiFullVersion":"1.0"}],"scheme":"http","nfServiceStatus":"REGISTERED"},{"serviceInstanceId":"2","serviceName":"nchf-spendinglimitcontrol","versions":[{"apiVersionInUri":"v1","apiFullVersion":"1.0"}],"scheme":"http","nfServiceStatus": "REGISTERED"}]}' | jq


# send a NF DISCOVERY request that is  answered by the NRFsim
export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

curl -v --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" --http2-prior-knowledge -X GET "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nnrf-disc/v1/nf-instances?requester-nf-type=UDM&target-nf-type=AMF" --cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem    | jq


metrics-query envoy_ip_address_hiding_applied_success 
metrics-query envoy_ip_address_hiding_fqdn_missing



############################################
# UC16: Local Rate Limiting (SCP 1.6)      # 
############################################

per listener, per worker  429  "Too many requests"

# export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
# k cp ~/demo/sepp_demo/sepp_demo_test.js ${K61_POD}:/tests/sepp_demo_test.js
# k cp ~/demo/sepp_demo/RP_206033.crt ${K61_POD}:/certs/RP_206033.crt
# k cp ~/demo/sepp_demo/RP_206033.key ${K61_POD}:/certs/RP_206033.key
# 
# export K62_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[1].metadata.name}")
# k cp ~/demo/sepp_demo/scp_stability_test_set1_b.js ${K62_POD}:/tests/scp_stability_test_set1.js
# k cp ~/demo/sepp_demo/RP_204060.crt ${K62_POD}:/certs/RP_204060.crt
# k cp ~/demo/sepp_demo/RP_204060.key ${K62_POD}:/certs/RP_204060.key

export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

#run traffic without Rate Limiting
k exec -it $K61_POD -- k6 run -e CERT=RP_206033.crt -e KEY=RP_206033.key -e RPS=400 -e DURATION=60s -e MAX_VUS=100 -e SEPP_IP=$NODE_IP -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_PORT=$SEPP_EXT_TLS_PORT -e TAR=http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org sepp_demo_test.js --insecure-skip-tls-verify  --no-usage-report

sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP

autowizard false
config

sepp-function nf-instance instance_1 local-rate-limit-profile profile100tps token-bucket max-tokens 1000
sepp-function nf-instance instance_1 local-rate-limit-profile profile100tps token-bucket tokens-per-fill 100
sepp-function nf-instance instance_1 local-rate-limit-profile profile100tps token-bucket fill-interval 1000
sepp-function nf-instance instance_1 external-network externalNetwork local-rate-limit-profile-ref profile100tps

show config

commit
end
exit



k exec -it $K61_POD -- k6 run -e CERT=RP_206033.crt -e KEY=RP_206033.key -e RPS=400 -e DURATION=30s -e MAX_VUS=40 -e SEPP_IP=$NODE_IP -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_PORT=$SEPP_EXT_TLS_PORT -e TAR=http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org sepp_demo_test.js --insecure-skip-tls-verify  --no-usage-report


# Restore

sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP
autowizard false
config
no sepp-function nf-instance instance_1 local-rate-limit-profile profile100tps
no sepp-function nf-instance instance_1 external-network externalNetwork local-rate-limit-profile-ref profile100tps
commit
end
exit


############################################
# UC16: Global Rate Limiting (SCP 1.8)     # 
############################################

#AMF from RP_BE sends 400MPS, 100MPS are accepted by SEPP, 300MPS rejected with 429, "Too may requests"


global-rate-limit-profile GRLRP
  sustainable-rate 100
  max-burst-size   50
  action-reject-message status 429
  action-reject-message title "Too many requests"
  action-reject-message cause NF_CONGESTION_RISK
  action-reject-message detail "RP limit exceeded"
  action-reject-message format json


export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

# k cp ~/demo/sepp_demo/sepp_demo_test.js ${K61_POD}:/tests/sepp_demo_test.js
# k cp ~/demo/sepp_demo/RP_206033.crt ${K61_POD}:/certs/RP_206033.crt
# k cp ~/demo/sepp_demo/RP_206033.key ${K61_POD}:/certs/RP_206033.key

#run traffic without Rate Limiting
k exec -it $K61_POD -- k6 run -e CERT=RP_206033.crt -e KEY=RP_206033.key -e RPS=400 -e DURATION=60s -e MAX_VUS=100 -e SEPP_IP=$NODE_IP -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_PORT=$SEPP_EXT_TLS_PORT -e TAR=http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org sepp_demo_test.js --insecure-skip-tls-verify  --no-usage-report

cat ~/demo/sepp_demo/addon_removal_rlf.xml | ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf																							  


############################################
# UC18: Alarm if too many TCP connections  #
############################################


# export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
# k cp ~/demo/sepp_demo/sepp_demo_test.js ${K61_POD}:/tests/sepp_demo_test.js
# k cp ~/demo/sepp_demo/RP_206033.crt ${K61_POD}:/certs/RP_206033.crt
# k cp ~/demo/sepp_demo/RP_206033.key ${K61_POD}:/certs/RP_206033.key
# 
# export K62_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[1].metadata.name}")
# k cp ~/demo/sepp_demo/scp_stability_test_set1_b.js ${K62_POD}:/tests/scp_stability_test_set1.js
# k cp ~/demo/sepp_demo/RP_204060.crt ${K62_POD}:/certs/RP_204060.crt
# k cp ~/demo/sepp_demo/RP_204060.key ${K62_POD}:/certs/RP_204060.key

export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

#run traffic 4000 TPS, mit max 120 VUS
k exec -it $K61_POD -- k6 run -e CERT=RP_206033.crt -e KEY=RP_206033.key -e DURATION=300s -e MAX_VUS=120 -e SEPP_IP=$NODE_IP -e SEPP_HOST=sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_PORT=$SEPP_EXT_TLS_PORT -e TAR=http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org sepp_demo_remote_vu.js --insecure-skip-tls-verify  --no-usage-report

k exec -it $K61_POD -- sh

k exec -it $K61_POD -- k6 scale -u 45
k exec -it $K61_POD -- k6 scale -u 65
k exec -it $K61_POD -- k6 scale -u 75
k exec -it $K61_POD -- k6 scale -u 10

--> show alarm history in logging


Reducing number of TCP connections only works if ingress-connection-profile timer has a low value, but this introduces spikes in graph.

sshpass -p syssys ssh -t -p $CLI_PORT sys-admin@$NODE_IP

expert@5gc-sc-testnode#show running-config pm job sepp_ingress_open_tcp_connections_job
pm job sepp_ingress_open_tcp_connections_job
 requested-job-state active
 type                threshold-job
 granularity-period  one-min
 measurement-reader sepp_ingress_open_tcp_connections_reader
  group-ref            sepp_ingress
  measurement-type-ref envoy_ingress_downstream_cx_active
  threshold-direction  increasing
  threshold-monitoring minor
   threshold-high     40
   threshold-low      30
   threshold-severity minor
  !
  threshold-monitoring critical
   threshold-high     70
   threshold-low      60
   threshold-severity critical
  !
  threshold-monitoring major
   threshold-high     60
   threshold-low      50
   threshold-severity major
  !
 !
!


pm job scp_ingress_open_tcp_connections_job
 requested-job-state active
 type                threshold-job
 granularity-period  one-min
 measurement-reader scp_ingress_open_tcp_connections_reader
  group-ref            scp_ingress
  measurement-type-ref envoy_ingress_downstream_cx_active
  threshold-direction  increasing
  threshold-monitoring scp_ingress_open_tcp_connections_threshold_monitoring
   threshold-high     40
   threshold-low      30
   threshold-severity minor
  !
  threshold-monitoring critical
   threshold-high     70
   threshold-low      60
   threshold-severity critical
  !
  threshold-monitoring major
   threshold-high     60
   threshold-low      50
   threshold-severity major
  !
 !
!

envoy_downstream_cx_active

http://pm.5g-bsf-eedcsi.hahn121.rnd.gic.ericsson.se:31784/graph?g0.expr=envoy_downstream_cx_active&g0.tab=0&g0.stacked=0&g0.range_input=5m

metrics-query envoy_downstream_cx_active

while(true); do \
echo metrics-query 'envoy_downstream_cx_active{nf_type="sepp"}' | sshpass -p rootroot ssh expert@$NODE_IP -p $CLI_PORT  2> /dev/null | tail -n +3  | jq '.data.result[].value[1]'\
; done

sshpass -p syssys ssh -p $CLI_PORT sys-admin@$NODE_IP
show running-config pm job sepp_ingress_open_tcp_connections_job

With bsf-load

export API_IP=$NODE_IP
export LOAD_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-bsf-load)


#Create new workload
curl -v -X POST http://$API_IP:$LOAD_PORT/bsf-load/run -H "Content-Type: application/json" -d @config_100tcp.json | jq

#Get all workload IDs
curl http://$API_IP:$LOAD_PORT/bsf-load/run | jq

#Get info on a workload
curl http://$API_IP:$LOAD_PORT/bsf-load/run/b71dc77e-a457-4eef-9e6b-38fad5c85ff2 | jq

#Delete a workload
curl -X DELETE http://$API_IP:$LOAD_PORT/bsf-load/run/b71dc77e-a457-4eef-9e6b-38fad5c85ff2 | jq

#Terminate a workload
curl -X POST http://$API_IP:$LOAD_PORT/bsf-load/terminate/dce9c7d8-f8a9-45a6-bddf-2ffb60e2fc7c | jq



############################################
# UC19: N32-c   (SEPP 1.10)                #
############################################

export NAMESPACE2=5g-bsf-eiffelesc-1
export YP_PORT2=$(kubectl get --namespace $NAMESPACE2 -o jsonpath="{.spec.ports[0].nodePort}" services eric-cm-yang-provider)
export CLI_PORT2=$(kubectl get --namespace $NAMESPACE2 -o jsonpath="{.spec.ports[1].nodePort}" services eric-cm-yang-provider)  # take the port mapped to 22

# load configuration for a Swedish SEPP in different namespace 5g-bsf-eiffelesc-1
~/bin/update_sepp_config.pl -f ~/demo/sepp_demo/config_new_sepp_demo_2023-04_amf-udm_sc1.11_sweden.xml -q sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org -n $NAMESPACE2 -t $NAMESPACE -s $NAMESPACE 
cat ~/sepp_sample_config.xml | ssh -t -p $YP_PORT2 sepp-admin@$NODE_IP -s netconf

# load configuration for a German SEPP in hahn121 node, including SEPP-SE port
~/bin/update_sepp_config.pl -f ~/demo/sepp_demo/config_new_sepp_demo_2023-04_amf-udm_sc1.11.xml -q sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org  -s $NAMESPACE2
cat ~/sepp_sample_config.xml | ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf


Set DNS entires for all needed PODs in /etc/hosts
-------------------------------------------------

Sweden (NAMESPACE2):

export NAMESPACE=5g-bsf-eedcsi
export NAMESPACE2=5g-bsf-eiffelesc-1
export SEPP_MANAGER_POD2=$(kubectl get pods --namespace $NAMESPACE2 -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")
export NAMESPACETOOLS=$NAMESPACE

export UDM1_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p1-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")
export UDM2_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p2-mcc-206-mnc-33 -o jsonpath="{.spec.clusterIP}")
export AMF_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p3-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

export SEPPBE_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p -o jsonpath="{.spec.clusterIP}")
export SEPPDE_SVC_IP=$NODE_IP

kubectl --namespace $NAMESPACE2 exec -it $SEPP_MANAGER_POD2 -c eric-sepp-manager  -- sh -c "echo ${UDM1_SVC_IP} nfudm1.region1.udm.5gc.mnc060.mcc240.3gppnetwork.org  >> /etc/hosts; echo ${UDM2_SVC_IP} nfudm2.region1.udm.5gc.mnc060.mcc240.3gppnetwork.org  >> /etc/hosts; echo ${AMF_SVC_IP} nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org  >> /etc/hosts"

kubectl --namespace $NAMESPACE2 exec -it $SEPP_MANAGER_POD2 -c eric-sepp-manager -- sh -c "echo ${SEPPBE_SVC_IP} sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org  >> /etc/hosts; echo ${SEPPDE_SVC_IP} sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"

#Verify
kubectl --namespace $NAMESPACE2 exec -it $SEPP_MANAGER_POD2 -c eric-sepp-manager -- cat /etc/hosts


Germany (NAMESPACE):

export SEPP_MANAGER_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")
export NAMESPACETOOLS=$NAMESPACE

export UDM1_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p4-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
export UDM2_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p5-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")
export AMF_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p6-mcc-262-mnc-73 -o jsonpath="{.spec.clusterIP}")

export SEPPBE_SVC_IP=$(kubectl get svc --namespace $NAMESPACETOOLS eric-seppsim-p -o jsonpath="{.spec.clusterIP}")
export SEPPSE_SVC_IP=$NODE_IP

kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager  -- sh -c "echo ${UDM1_SVC_IP} nfUdm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts; echo ${UDM1_SVC_IP} nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts; echo ${UDM2_SVC_IP} nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts; echo ${AMF_SVC_IP} nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org  >> /etc/hosts"

kubectl --namespace 5g-bsf-eedcsi exec -it $SEPP_MANAGER_POD -c eric-sepp-manager -- sh -c "echo ${SEPPSE_SVC_IP} sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org  >> /etc/hosts; echo ${SEPPBE_SVC_IP} sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org  >> /etc/hosts; echo ${SEPPBE_SVC_IP} nfUdm1.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org >> /etc/hosts"

#Verify
kubectl --namespace $NAMESPACE exec -it $SEPP_MANAGER_POD -c eric-sepp-manager -- cat /etc/hosts

#load certificates



RP_DE 

RP_BE  - simulated by seppsim eric-seppsim-p

export MONITOR_USER=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.username}' | base64 -d)
export MONITOR_PWD=$(k get secret eric-sc-monitor-secret -o jsonpath='{.data.password}' | base64 -d)
export MONITOR_PORT=$(k get services eric-tm-ingress-controller-cr -o jsonpath="{.spec.ports[1].nodePort}")
export MONITOR_URL=$(k get httpproxy sc-httpproxy -o jsonpath="{.spec.virtualhost.fqdn}")

curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?command=list" |jq


Set Own PLMN-iD for SEPPsim
---------------------------
curl -u ${MONITOR_USER}:${MONITOR_PWD} -k -X GET "https://${MONITOR_URL}:${MONITOR_PORT}/monitor/api/v0/commands?target=eric-seppsim-p-&command=config" -d '{"ownRole": "SEPP_OR_NF", "ownDomain": "region1.udm.5gc.mnc033.mcc206.3gppnetwork.org", "supportedPlmn":[[{"mcc":"206","mnc":"033"}]]}' | jq

k delete secret seppsim-certificates
k create secret generic seppsim-certificates \
 --from-file=./cert.pem \
 --from-file=./key.pem \
 --from-file=./rootCA.crt

k delete secret seppsim-certificates-px
k create secret generic seppsim-certificates-px \
 --from-file=./cert.pem \
 --from-file=./key.pem \
 --from-file=./rootCA.crt

delete seppsim-p-xxxx pod

----

Germany:
ssh -p $CLI_PORT expert@$NODE_IP

sepp-function nf-instance instance_1 external-network externalNetwork
  roaming-partner RP_SE
   domain-name              [ *.region1.udm.5gc.mnc060.mcc240.3gppnetwork.org *.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org *.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org ]
   trusted-certificate-list sc-traf-root-ca-list2
   supports-target-apiroot negotiated
   n32-c enabled false
   n32-c nf-pool-ref sepp_RP_SE_pool
   n32-c allow-plmn primary-id-mcc 240
   n32-c allow-plmn primary-id-mnc 060

  roaming-partner RP_BE
   domain-name              [ *.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org *.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org ]
   trusted-certificate-list sc-traf-root-ca-list2
   supports-target-apiroot negotiated
   n32-c enabled false
   n32-c nf-pool-ref sepp_RP_BE_pool
   n32-c allow-plmn primary-id-mcc 206
   n32-c allow-plmn primary-id-mnc 033

sepp-function nf-instance instance_1
 n32-c own-security-data 262 072
  security-capability     [ TLS ]
  supports-target-apiroot true
commit

sepp-function nf-instance instance_1 
 static-nf-instance-data static_sepp_RP_SE_data 
  static-nf-instance sepp_SE 
   static-nf-service default 
    address multiple-ip-endpoint 1 port 30754   # change port to SEPP-SE service port

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_BE n32-c enabled false
commit                                                                                      
																						    
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_BE n32-c enabled true
commit

show running-config sepp-function nf-instance instance_1 external-network externalNetwork
show running-config sepp-function nf-instance instance_1 n32-c


Sweden:
export CLI_PORT2=$(kubectl get --namespace $NAMESPACE2 -o jsonpath="{.spec.ports[1].nodePort}" services eric-cm-yang-provider)  # take the port mapped to 22
ssh -p $CLI_PORT2 expert@$NODE_IP

sepp-function nf-instance instance_1 external-network externalNetwork
  roaming-partner RP_BE
   domain-name              [ *.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org *.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org ]
   trusted-certificate-list sc-traf-root-ca-list2
   supports-target-apiroot  true
   n32-c enabled false
   n32-c nf-pool-ref sepp_RP_BE_pool
   n32-c allow-plmn primary-id-mcc 206
   n32-c allow-plmn primary-id-mnc 033
   
  roaming-partner RP_DE
   domain-name              [ *.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org *.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org *.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org ]
   trusted-certificate-list sc-traf-root-ca-list2
   supports-target-apiroot  true
   n32-c enabled false
   n32-c nf-pool-ref sepp_RP_DE_pool
   n32-c allow-plmn primary-id-mcc 240
   n32-c allow-plmn primary-id-mnc 060

sepp-function nf-instance instance_1
 n32-c own-security-data 240 060
  security-capability     [ TLS ]
  supports-target-apiroot true

!! update the port of SEPP-DE, eric-sepp-worker-2 port mapped to 443
sepp-function nf-instance instance_1 
 static-nf-instance-data static_sepp_RP_DE_data 
  static-nf-instance sepp_DE 
   static-nf-service default 
    address multiple-ip-endpoint 1 port 31834


sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled false
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_BE n32-c enabled false
commit

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled true
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_BE n32-c enabled true
commit

--- load in DE ---

truststore certificates sc-traf-root-ca-list2 install-certificate-pem name rp_se_rootca pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmVENDQVNRQ0NRQ0xUOWJQUThqZm1EQUtCZ2dxaGtqT1BRUURBakJITVFzd0NRWURWUVFHRXdKVFJURVMKTUJBR0ExVUVCd3dKVTNSdlkydG9iMnh0TVJFd0R3WURWUVFLREFoRmNtbGpjM052YmpFUk1BOEdBMVVFQXd3SQpZMkZmY25CZmMyVXdIaGNOTWpJeE1URTNNVFl3TmpReVdoY05NalV4TVRFMk1UWXdOalF5V2pCSE1Rc3dDUVlEClZRUUdFd0pUUlRFU01CQUdBMVVFQnd3SlUzUnZZMnRvYjJ4dE1SRXdEd1lEVlFRS0RBaEZjbWxqYzNOdmJqRVIKTUE4R0ExVUVBd3dJWTJGZmNuQmZjMlV3V1RBVEJnY3Foa2pPUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVRGald5NAo0QjhRR2ZaVFpwR3lqdVZNQjd3UTJVN2V1V1RKZFFpdjJybnBvS2ROLzhoNU1PaVc5S01FM3VqYjRHYjdNMTg3Cks1bm9Ua05tclFOYitLRG1NQW9HQ0NxR1NNNDlCQU1DQTBjQU1FUUNJQjlsRVN0QVM2U3VNSHIrT0xWT0JMNTYKUHhnck5vTUkrK0NMNE4xNUxYcjZBaUFSbzBxZXRsU1NaM3lXak93U2hMektSZGlqVGU4ZnJvTDVMajZJOEUregplZz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K

truststore certificates sc-traf-root-ca-list2 install-certificate-pem name rp_be_rootca pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlekNDQVNJQ0NRQ3hTamNZMkZ3Qmp6QUtCZ2dxaGtqT1BRUURBakJHTVFzd0NRWURWUVFHRXdKQ1JURVIKTUE4R0ExVUVCd3dJUW5KMWMzTmxiSE14RVRBUEJnTlZCQW9NQ0VWeWFXTnpjMjl1TVJFd0R3WURWUVFEREFoagpZVjl5Y0Y5aVpUQWVGdzB5TWpFeE1UY3hOakEyTURoYUZ3MHlOVEV4TVRZeE5qQTJNRGhhTUVZeEN6QUpCZ05WCkJBWVRBa0pGTVJFd0R3WURWUVFIREFoQ2NuVnpjMlZzY3pFUk1BOEdBMVVFQ2d3SVJYSnBZM056YjI0eEVUQVAKQmdOVkJBTU1DR05oWDNKd1gySmxNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV4MDdTbnhZTwpqNGtLaGFpZ0ZBK2g5bUlnYityT0FwSHZ6T3JMSHlkbEZnN3ZURnFnc1RsQjRZKzhMYkZqT3JyTEtneGdGY2VGCmZLVllMcDc3THpxTHlqQUtCZ2dxaGtqT1BRUURBZ05IQURCRUFpQm9teUZyQzlLcWI3NW4yS0dYdXRDOVF4NW8KSUowSGFyc0h2RXlGc1k1czNRSWdYTmkvTE5JNDBlYjducWpvZ21sNG5RSVpuUnhKQ1BFNlQxVUZFeFFrU2dNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==

openssl pkcs12 -export -inkey RP_262072-sepp-key.pem -in RP_262072-sepp-cert.pem -out RP_262072.p12 -passout pass:"rootroot"
base64 -w 0 RP_262072.p12
keystore asymmetric-keys install-asymmetric-key-pkcs12 name sc-traf-default-key2 certificate-name sc-traf-default-cert2 p12-password rootroot p12 MIII+QIBAzCCCL8GCSqGSIb3DQEHAaCCCLAEggisMIIIqDCCA18GCSqGSIb3DQEHBqCCA1AwggNMAgEAMIIDRQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQYwDgQITe6sZcNQ1UECAggAgIIDGAJzNSOmsV+avlH3UjwCW1JC6/MpWrmZFYOGGwHO+EDJyjbq3LhtKrM7wEqq2PEbY5mTtwXCuX4/qhGAAGV+wS+MbEaxnFy1aEf0QGZ1MkC3SZUQOgsmJ7Cp26PaIA8QhXb7mpOkQlp+yUyKgDcJWes+PI5hK7j3I+WwN1cCGFDc9tZCUlSsvkEe8X60GeWMnPVxLNWjwK+E04LJSrggUYfI1hPrnh3iC6v7N61g5pISq14wQBJDGasVYJtcoizPEved4eNADVsyffNyi41/5wFycfuR6EEHOdKhuT5/0gpDCOudt/eZ94RE6rV93C4LFAyHenK4q0qgL0f99ssFvJ9gYncjcfUBGP/NWK8lEAkEHGWEuA0NzEGcPUM+flS3ODB8wmddlvhasoLm8m4jCYYUfFNmtjacPln1u4Eg0DzTzvhzliL17B5k7eXpo0WIJFJYQsjz8tSonT1aSgxt7HyzK+w2rrOvhYW1InZjIghEMTxqg4KeWacGbbkGdmpw+qkPmtNEBC14dszRQRcD///hgwmdJEfOZGpKl8DsumkclYO3IgL+CLTXdiLvzv5BB7PHN1LVplRG9g6SyG7I5SwA9i4RtcYtt2z6oVYKo3X6w1LI/Rw6Jnq3NVNaKeZxw6rCKOecEsQT85/wBLcJ2+S6B7cGSvyfHFwJ79c+XXEbCgkNkw+mHuiAuADt1CORAN9OVNvfXFAs6opB2H3rxTvdhQ5JzQHBH0Hhxm9Keit77uNr5Ya3haesffmYIQz2KcmsdlG3gPTnkzzlGOV4E2hb4K3vqmhqLVZuodZGdyL3Xg0BkKfOslHew0Xk7B21KIBYjSLcKwNDDe69oj5QrXh6SXiBSQJ/tB4Z9RZwlzT5VJiUvownBOVB3bQ84aggJi/9Uo1NtU7oy65n58ZuBjTv2FeM/CwM7WTYEgNj8JPD9Nl6z6SnIFKeAU7SoDrPVt6FxOHKoNmILNGiRWHhgQ/8MUvKez4DMmVITlcW0rCSgapvGyg5jO5DRbUODRqNTxXPgOPPsewI7ifykQGGuO83e1JF+uXaFjCCBUEGCSqGSIb3DQEHAaCCBTIEggUuMIIFKjCCBSYGCyqGSIb3DQEMCgECoIIE7jCCBOowHAYKKoZIhvcNAQwBAzAOBAiIDR8wAVGUfwICCAAEggTIK1qJjwPmdaYirxLNAhBKS+lFuEBmNOBDqc7ehPZukItL3mU7ut+SZMNK20qofNgHvmasmooARwH/cyGayBJ0Dj9OmOHYuRcsXT5gKgsWcrLm6+lL4w1u4T95gQCjH8j5BPYBQg6/NABimygtOLegU2YHJ0U15eYR63zu9r/WnC2hhcz6ycR8d30TBJfhXKR38u0fmc7YKiiRIPhxNYVeG/EWjV910cy8sQBmoQWHqY0Lv1htJ7WgW541TBun56o/0osLc5AJE5I1D4mPjo+4ETziD9fNSB4MdHghFBeGixqvaLq28sjTeA1vNjuaPNw1rCqGqb6nctEYkWcFkdQns8Od4vS+jl24PqDWNIQ3ypuSzD68lhH/ugUkQAyP21qX49SCXd5YdA2W0AF7z2YJthaDyrHYQALe1xme97oGUHtNXHWdAH62RppaT1tzjGK3G+k94sW9UZ+BTwjqF9vX1nY1/NbE7qEif8Fqk70haS+v2oqYVJY1kikNig8FnxsdRFHckoHIK7LY0wo7Q3ieHJsQcgnVcbq+Q3WBLIjUPZpdxqnmkB5QE9Gzq2eUFoKYOiiv5lI04U15iMAxj6B0Eoq8t0y6/1LjKdEVvNPxaX+EZoMJ+n0NS+0aqFIubh3OkSjoZu+6iwrDC81bFtwUudR3o1D2Pl7+hRY3pE6DVqE2cd8thC6LeMioRa+bcdF/nD2LItuwz8fP1q48hvh+PI0rvboUVZ/qr7hZxywd1JpQ60I9sAMFZWmE7OXd4l715r4nxudBa8sn7Z8YSMY6NdjMBfwafZ1ge2GAZFuErcSFidrv4Urp5jfGoYv/Fd+VCpaPFgkl5lPHW3sc0K60S8CQNK3AlmPesa3nt8AWYsIX3TfrAmAa9JCM92z9hHR8ygmFWK4koUekfiVDjGUSFvd9xa9lrZG701hg5Y5oUWzsbE2lb5U1oVd5Ls7ApowvTPB2lSsPnCMamKuVTrqRdgxv11hhZjctcXNJFALaHS0ZLruIgre4CTkijEuRmoTmybt5CMvGtek+wlrBmA90e/fQCL4dueXzDhb6Yc6eX7BqnPKTzwCazT1BxWor76VQiRJ31/GkvDp0fq/G0AacJs/ZpyhNO3JSasxu1hE6OEstoeyNdodgriCsbp5XZNCdAKJx0T2MRNi1DdRbbsIEauFS6sJ07G1Z5LC97pubtDX2SxjNvCmqPFxs1TobGot7U3hK5VW9XDl9mQ5OY1tVBMUFo5VSw2GTsdueq/tMHMIwcirwRutrOmznkONAgvcU41U1j7YnESC5fquTaEJI65UzuxB5tTCs6D70PVQShs9oSwz8U7DYWPOAYlS3LClJqOZaUJhA/gTYdId7BPaYgkEYrzcc0VyvUnjgfZzYQKOfPdaNKZkKbYtIAMcW+X5Oq/TZ8Gk8lIC2p3/9J+6EXa7JqYsHM8pPSw8ndoYa3VF/kH3OXq+pb+4B/Ra97RGYLGfExMmzh+W8KtxVz4UvLRJDUPtA1eGm7EAJe5aUplCI81042+WMkTLogH+QljA/+7/bwZNt0hMr11YBoJWqJHUfpxWJ5zUsTEJgZKiTe2Ro77qtJAeuuPBREUu1mZiPQso1C+wh/ZMy5xJ6lgvfBd+/d+F2ynWkMSUwIwYJKoZIhvcNAQkVMRYEFGEYIRQ5GsRGqgJHFhsK/OQAYvXGMDEwITAJBgUrDgMCGgUABBS0XiESOCAfeXCxU0RfIJqp9cVMfQQIAfH46CQz6d8CAggA


--- load in sepp-SE ---
truststore certificates sc-traf-root-ca-list2 install-certificate-pem name rp_de_rootca pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkVENDQVJvQ0NRQzc5K3ZURFROc1VUQUtCZ2dxaGtqT1BRUURBakJDTVFzd0NRWURWUVFHRXdKRVJURVAKTUEwR0ExVUVCd3dHUW1WeWJHbHVNUkV3RHdZRFZRUUtEQWhGY21samMzTnZiakVQTUEwR0ExVUVBd3dHWTJGZgpiM2R1TUI0WERUSXlNVEV4TnpFMk1EWTBNbG9YRFRJMU1URXhOakUyTURZME1sb3dRakVMTUFrR0ExVUVCaE1DClJFVXhEekFOQmdOVkJBY01Ca0psY214cGJqRVJNQThHQTFVRUNnd0lSWEpwWTNOemIyNHhEekFOQmdOVkJBTU0KQm1OaFgyOTNiakJaTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEEwSUFCTTFOUkFPOE4vcmNsOXlPaVZDZAo0Vnd3N0U4NjgzNWFNTU1FUHhRVjJnMlcwcFBZTjJLM3B6UW10THRleEV3TGxjVW9jNExQeGhmM0U5eXZWVVFXCnVwTXdDZ1lJS29aSXpqMEVBd0lEU1FBd1JnSWhBUDYxVHpkRWdGQTVKUXZUWkliQTZuNktPZnVhanBlb2FPVEYKY0xHZzBOSXVBaUVBc0lXUVEvQzdVUkhWNlF1WWM0VmhqaFUwRlVVVUViTGx1djJkZlJzWFlKYz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=

truststore certificates sc-traf-root-ca-list2 install-certificate-pem name rp_be_rootca pem LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlekNDQVNJQ0NRQ3hTamNZMkZ3Qmp6QUtCZ2dxaGtqT1BRUURBakJHTVFzd0NRWURWUVFHRXdKQ1JURVIKTUE4R0ExVUVCd3dJUW5KMWMzTmxiSE14RVRBUEJnTlZCQW9NQ0VWeWFXTnpjMjl1TVJFd0R3WURWUVFEREFoagpZVjl5Y0Y5aVpUQWVGdzB5TWpFeE1UY3hOakEyTURoYUZ3MHlOVEV4TVRZeE5qQTJNRGhhTUVZeEN6QUpCZ05WCkJBWVRBa0pGTVJFd0R3WURWUVFIREFoQ2NuVnpjMlZzY3pFUk1BOEdBMVVFQ2d3SVJYSnBZM056YjI0eEVUQVAKQmdOVkJBTU1DR05oWDNKd1gySmxNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUV4MDdTbnhZTwpqNGtLaGFpZ0ZBK2g5bUlnYityT0FwSHZ6T3JMSHlkbEZnN3ZURnFnc1RsQjRZKzhMYkZqT3JyTEtneGdGY2VGCmZLVllMcDc3THpxTHlqQUtCZ2dxaGtqT1BRUURBZ05IQURCRUFpQm9teUZyQzlLcWI3NW4yS0dYdXRDOVF4NW8KSUowSGFyc0h2RXlGc1k1czNRSWdYTmkvTE5JNDBlYjducWpvZ21sNG5RSVpuUnhKQ1BFNlQxVUZFeFFrU2dNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==


openssl pkcs12 -export -inkey ~/demo/sepp_demo/certificates/RP_240060-sepp-key2.pem -in ~/demo/sepp_demo/certificates/RP_240060-sepp-cert2.pem -out ~/demo/sepp_demo/certificates/RP_240060_2.p12 -passout pass:"rootroot"
base64 -w 0 ~/demo/sepp_demo/certificates/RP_240060_2.p12 > ~/demo/sepp_demo/certificates/RP_240060-base64_2.p12

keystore asymmetric-keys install-asymmetric-key-pkcs12 name sc-traf-default-key2 certificate-name sc-traf-default-cert2 p12-password rootroot p12 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


--- load in sepp-BE ---
openssl pkcs12 -export -inkey RP_206033-sepp-key.pem -in RP_206033-sepp-cert.pem -out RP_206033.p12 -passout pass:"rootroot"
base64 -w 0 RP_206033.p12 > RP_206033-base64.p12

keystore asymmetric-keys install-asymmetric-key-pkcs12 name sc-traf-default-key2 certificate-name sc-traf-default-cert2 p12-password rootroot p12 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


in seppsim for sepp-be:
cd ~/demo/sepp_demo/certificates
cert.pem -> RP_206033-sepp-cert.pem
key.pem -> RP_206033-sepp-key.pem
rootCA.crt -> rootCA_DE-cert.pem

# NOTE: seppsim-certificates-p is not used by seppsim-p-
k delete secret seppsim-certificates
k create secret generic seppsim-certificates \
 --from-file=./cert.pem \
 --from-file=./key.pem \
 --from-file=./rootCA.crt

delete seppsim-p-xxxx pod

------------------------

checks:
Sweden:
export SEPP_POD2=$(kubectl get pods -n $NAMESPACE2 -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

ke exec -it $SEPP_POD2 -c eric-sepp-worker --  curl -X POST "http://localhost:9901/clusters"  | grep -i n32

kubectl -n $NAMESPACE2 exec -it $SEPP_POD2  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=trace"  
kubectl -n $NAMESPACE2 exec -it $SEPP_POD2  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=info"  

reset; ke logs -f $SEPP_POD2 -c eric-sepp-worker --tail=0  | jl3


2023-01-18T16:44:20.781+00:00 | DEBUG    |   82 | ions/transport_sockets/tls/ssl_socket.cc:228  |     | C15499    |                       | remote address:10.111.223.37:443,TLS error: 268436536:SSL routines:OPENSSL_internal:TLSV1_ALERT_INTERNAL_ERROR

#send handshake message to seppsim-p (simulating RP-BE)
curl -v --http2-prior-knowledge  -X POST --resolve "sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org:30654:$NODE_IP"   "https://sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org:30654/n32c-handshake/v1/exchange-capability" -H "Content-Type: application/json" -d '{"sender":"sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org","supportedSecCapabilityList":["TLS"],"3GppSbiTargetApiRootSupported":true,"plmnIdList":[{"mcc":"240","mnc":"060"}],"targetPlmnId":{"mcc":"206","mnc":"033"}}'  --cert ~/demo/sepp_demo/certificates/RP_240060-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_240060-sepp-key.pem --cacert  ~/demo/sepp_demo/certificates/rootCA_RPBE-cert.pem | jq


Germany: 
export SEPP_POD=$(kubectl get pods -n $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

k exec -it $SEPP_POD -c eric-sepp-worker --  curl -X POST "http://localhost:9901/clusters"  | grep -i n32


export SEPP_POD=$(kubectl get pods -n $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
kubectl -n $NAMESPACE exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=trace"  
kubectl -n $NAMESPACE exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=info"  

reset; k logs -f $SEPP_POD -c eric-sepp-worker --tail=0  | jl3


export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)
export SEPP_EXT_TLS_PORT2=$(kubectl get --namespace $NAMESPACE2 -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

curl -v --http2-prior-knowledge  -X POST --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP"   "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/n32c-handshake/v1/exchange-capability" -H "Content-Type: application/json" -d '{"sender":"sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org","supportedSecCapabilityList":["TLS"],"3GppSbiTargetApiRootSupported":true,"plmnIdList":[{"mcc":"240","mnc":"060"}],"targetPlmnId":{"mcc":"262","mnc":"072"}}'  --cert ~/demo/sepp_demo/certificates/RP_240060-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_240060-sepp-key.pem --cacert  ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem | jq

#curl -v --http2-prior-knowledge  -X POST --resolve "sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org:$SEPP_EXT_TLS_PORT2:$NODE_IP"   "https://sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org:$SEPP_EXT_TLS_PORT2/n32c-handshake/v1/exchange-capability" -H "Content-Type: application/json" -d '{"sender":"sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org","supportedSecCapabilityList":["TLS"],"3GppSbiTargetApiRootSupported":true,"plmnIdList":[{"mcc":"262","mnc":"072"}],"targetPlmnId":{"mcc":"206","mnc":"033"}}'  --cert ~/demo/sepp_demo/certificates/RP_262072-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_262072-sepp-key.pem --cacert  ~/demo/sepp_demo/certificates/rootCA_RPBE-cert.pem | jq


ERROR cases
===========

   roaming-partner RP_DE
    n32-c
	-
	
   roaming-partner RP_SE
    n32-c
     security-negotiation-data sepp_SE-seppsim-p8
      last-update 2023-01-19T13:10:30.253+00:00
      operational-state
       value  faulty
       reason "status code: 400, title: Bad Request, detail: Mandatory element sender does not match any of the configured remote sepp addresses, cause: UNSPECIFIED_MSG_FAILURE"
-> The other SEPP did have n32-c enabled false

Configuration:
Sweden: 
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled false
commit

Germany
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
commit
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
commit



---------
SEPP1 (DE):
   roaming-partner RP_SE
    n32-c
     security-negotiation-data sepp_SE-seppsim-p8
      last-update 2023-01-19T13:10:30.253+00:00
      operational-state
       value  faulty
       reason "status code: 400, title: Bad Request, detail: Received plmnIds do not match the configured ones, cause: UNSPECIFIED_MSG_FAILURE"

SEPP2 (SE):
   roaming-partner RP_DE
    n32-c
     security-negotiation-data sepp_DE
      last-update 2023-01-19T13:21:31.221+00:00
      operational-state
       value  faulty
       reason "Received plmnIdList does not match (totally or partially) the configured allow-plmn list of the RP, Received plmnIdList: [{ mcc: 262 mnc: 072}, { mcc: 262 mnc: 073}], Configured allow-plmn list of the RP: [{ mcc: 262 mnc: 072}]"
	   
-> too many PLMNids in initiating SEPP (own n32-c includes additional plmnid 262 073), not all match the receiver => either remove on sending side or add on receiving side
In case receiver has more than sender, then there is no error 

Configuration:
Sweden: 
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled false
commit

Germany
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
commit

sepp-function nf-instance instance_1
 n32-c own-security-data 262 072
  additional-plmn-id 262 073
commit

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
commit

Restore:
no sepp-function nf-instance instance_1 n32-c own-security-data 262 072 additional-plmn-id
commit


---------
SEPP1 (DE):
   roaming-partner RP_SE
    n32-c
     security-negotiation-data sepp_SE-seppsim-p8
      last-update 2023-01-23T09:35:13.956+00:00
      operational-state
       value  faulty
       reason "status code: 400, title: Bad Request, detail: Target plmnId is not configured, cause: UNSPECIFIED_MSG_FAILURE"

SEPP2 (SE):
   roaming-partner RP_DE
    n32-c
     security-negotiation-data sepp_DE
      last-update 2023-01-23T09:38:16.537+00:00
      operational-state
       value  faulty
       reason "Received target plmnId does not match the configured plmnIds. Received target plmnId: { mcc: 266 mnc: 060}, Configured plmnId list of the RP: [{ mcc: 240 mnc: 060}]"
-> SEPP1(DE) has wrong PLMN-ID of SEPP2(SE) defined

Configuration:

Germany
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE 
   n32-c allow-plmn primary-id-mnc 666
commit

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
commit

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
commit


Restore
- - - - 
Germany
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE 
   n32-c allow-plmn primary-id-mnc 060
commit



---------
SEPP1:
   roaming-partner RP_SE
    n32-c
     security-negotiation-data sepp_SE-seppsim-p8
      last-update 2023-01-23T09:55:41.457+00:00
      operational-state
       value  faulty
       reason "Received plmnIdList does not match (totally or partially) the configured allow-plmn list of the RP, Received plmnIdList: [{ mcc: 240 mnc: 060}, { mcc: 266 mnc: 060}], Configured allow-plmn list of the RP: [{ mcc: 266 mnc: 060}]"

SEPP2:
   roaming-partner RP_DE
    n32-c
     security-negotiation-data sepp_DE
      last-update 2023-01-23T09:53:41.293+00:00
      operational-state
       value  faulty
       reason "status code: 400, title: Bad Request, detail: Received plmnIds do not match the configured ones, cause: UNSPECIFIED_MSG_FAILURE"
-> one SEPP1 has not all PLMN-ID of SEPP2 defined  => n32-c allow-plmn additional-id 240 060


---------

If FQDN of SEPP2 is not resolvable, the pool has no members in Envoy -> 503 sent from Envoy to SEPP-manager
Same for TLS problem, receiving SEPP rejects the connection

   roaming-partner RP_XX
    n32-c
     security-negotiation-data sepp_XX
      last-update 2023-01-24T10:25:44.219+00:00
      operational-state
       value  faulty
       reason "status code: 503, title: Service Unavailable"
	   
	   
---------

if no FQDN, but IP address in static SEPP2 definition, the state stays on "inactive" and no reason given

   roaming-partner RP_XX
    n32-c
     security-negotiation-data sepp_XX
      last-update 2023-01-24T10:00:30.956+00:00
      operational-state
       value inactive


---------

For some time, show values are good, but then they change to e.g. 
   roaming-partner RP_DE
    n32-c
     security-negotiation-data sepp_DE
      last-update 2023-01-19T15:23:17.953+00:00
      operational-state
       value  faulty
       reason "status code: 503, title: Service Unavailable"
-> own n32-c handshake initiation does not work, but responding is fine  (other side does not show error)


---------
Check ETCD:
k exec -it eric-data-distributed-coordinator-ed-sc-0  -c dced -- etcdctl get /ericsson/sc/sepp/n32c --prefix
#k exec -it eric-data-distributed-coordinator-ed-sc-0  -c dced -- etcdctl get /ericsson/sc/sepp/n32c/RP_BE/sepp_RP_BE --prefix --print-value-only | jq


---------
metrics

        "n32c_in_requests_created",
        "n32c_in_requests_total",
        "n32c_in_responses_failure_created",
        "n32c_in_responses_failure_total",
        "n32c_in_responses_protocol_failure_created",
        "n32c_in_responses_protocol_failure_total",
        "n32c_in_responses_success_created",
        "n32c_in_responses_success_total",
        "n32c_out_requests_created",
        "n32c_out_requests_total",
        "n32c_out_responses_failure_created",
        "n32c_out_responses_failure_total",
        "n32c_out_responses_success_created",
        "n32c_out_responses_success_total",


metrics-query n32c_in_requests_total



------------------------
Traffic Messages
------------------------
SE - DE
export NAMESPACE2=5g-bsf-eiffelesc-1

export SEPP_PORT2=$(kubectl get --namespace $NAMESPACE2 -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)

curl -v --http2-prior-knowledge  -X POST --resolve "sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org:$SEPP_PORT2:$NODE_IP"  "http://sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org:$SEPP_PORT2/namf-comm/v1/ue-contexts/imsi-2060330007487/n1-n2-messages/subscriptions" -H "3gpp-Sbi-target-apiRoot:http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"n2InformationClass":"SM","n2NotifyCallbackUri":"http://nfudm-se.region1.udm.5gc.mnc060.mcc240.3gppnetwork.org","n1MessageClass":"5GMM","n1NotifyCallbackUri":"http://nfudm-se.region1.udm.5gc.mnc040.mcc262.3gppnetwork.org","nfId":"123e4567-e89b-12d3-a456-426614174000","supportedFeatures":"599E51", "guami":{"plmnId":{"mcc":"240","mnc":"060"},"amfId":"Fc4E30"}}' | jq


DE - SE

export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)

curl -v --http2-prior-knowledge  -X POST --resolve "sepp1.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP"  "http://sepp1.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/namf-comm/v1/ue-contexts/imsi-2060330007487/n1-n2-messages/subscriptions" -H "3gpp-Sbi-target-apiRoot:http://nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org" -H "Content-Type: application/json" -d '{"n2InformationClass":"SM","n2NotifyCallbackUri":"http://nfudm-de.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","n1MessageClass":"5GMM","n1NotifyCallbackUri":"http://nfudm-se.region1.udm.5gc.mnc040.mcc262.3gppnetwork.org","nfId":"123e4567-e89b-12d3-a456-426614174000","supportedFeatures":"599E51", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}}' | jq



Egress traffic rejected, if n32-c not established
--------------------------------------------------
Sweden: 
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled false
commit

Germany
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
commit
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
commit


Traffic Messages, DE - SE   -> rejected

export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)

curl -v --http2-prior-knowledge  -X POST --resolve "sepp1.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP"  "http://sepp1.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/namf-comm/v1/ue-contexts/imsi-2060330007487/n1-n2-messages/subscriptions" -H "3gpp-Sbi-target-apiRoot:http://nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org" -H "Content-Type: application/json" -d '{"n2InformationClass":"SM","n2NotifyCallbackUri":"http://nfudm-de.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org","n1MessageClass":"5GMM","n1NotifyCallbackUri":"http://nfudm-se.region1.udm.5gc.mnc040.mcc262.3gppnetwork.org","nfId":"123e4567-e89b-12d3-a456-426614174000","supportedFeatures":"599E51", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}}' | jq


{
  "status": 504,
  "cause": "TARGET_NF_NOT_REACHABLE",
  "detail": "no_healthy_upstream",
  "title": "Gateway Timeout"
}


Restore:

Sweden: 
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled true
commit




############################################
# UC19b: N32-c enhancements (SC 1.11)     #
############################################

SEPP supports the N32-c control plane interface to perform the initial handshake and agree on a security mechanism to use for protecting NF service related signaling over N32-f to/from the roaming partners SEPP(s). The following enhancements of this functionality have been implemented:
- Tracing of N32-c handshake requests by means of SW probe vTAP functionality

- Ingress traffic from a roaming partners SEPP instance is rejected if security capability negotiation procedure has not been successfully completed

- (SC 1.10.1 already ??) When the Security Capability Negotiation Procedure is successfully completed, the agreed handshake information is stored in yang model as state security-negotiation-data per roaming partner's SEPP instance. Till now, a user could request to see the data by requesting them ALL, specific Roaming Partner or specific SEPP instance of a Roaming Partner. The mechanism is now enhanced so as the user to be able to request specific data inside the SEPP instance of a Roaming Partner like last-update of the handshake procedure.


VTAP, PVTB:
-----------

kgp -o wide |grep  vtap  # take the cluster-ip for vtap pod and use it below in the address of the stream_consumer


sepp-function nf-instance instance_1
 vtap enabled true
 vtap vtap-configuration proxy ingress own_tap
  external-network-ref [ externalNetwork ]
  enabled true
 vtap vtap-configuration proxy egress egress_tap
  nf-pool-ref [ sepp_RP_SE_pool ]
  enabled true
commit
  
vtap profiles profile vtap_profile1 domain sc-sepp protocol raw-sbi
vtap stream-consumers stream-consumer stream_consumer_1 address 192.168.154.135 tapping-profile vtap_profile1
vtap enabled true
commit

#Maximum of five streaming consumers can be configured.

# show output
echo "show running-config sepp-function nf-instance instance_1 vtap" | sshpass -p rootroot ssh -p $CLI_PORT expert@$NODE_IP 2> /dev/null
echo "show running-config vtap" | sshpass -p rootroot ssh -p $CLI_PORT expert@$NODE_IP 2> /dev/null


export TAPREC_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-vtaprecorder-0)
echo $TAPREC_PORT; echo $NODE_IP

curl -X POST $NODE_IP:$TAPREC_PORT/start
curl -X POST $NODE_IP:$TAPREC_PORT/stop
curl -X GET $NODE_IP:$TAPREC_PORT/status | jq
curl -X GET $NODE_IP:$TAPREC_PORT/pcapng --output "$(date +"%FT%H%M%S").pcapng"

sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
commit                                                                                      
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
commit


Ingress traffic rejected, if n32-c not established
--------------------------------------------------
Sweden: 
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled false
commit

Germany
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled false
commit
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_SE n32-c enabled true
commit


Traffic Messages, SE - DE

export SEPP_PORT2=$(kubectl get --namespace $NAMESPACE2 -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)

curl -v --http2-prior-knowledge  -X POST --resolve "sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org:$SEPP_PORT2:$NODE_IP"  "http://sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org:$SEPP_PORT2/namf-comm/v1/ue-contexts/imsi-2060330007487/n1-n2-messages/subscriptions" -H "3gpp-Sbi-target-apiRoot:http://nfamf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"n2InformationClass":"SM","n2NotifyCallbackUri":"http://nfudm-se.region1.udm.5gc.mnc060.mcc240.3gppnetwork.org","n1MessageClass":"5GMM","n1NotifyCallbackUri":"http://nfudm-se.region1.udm.5gc.mnc040.mcc262.3gppnetwork.org","nfId":"123e4567-e89b-12d3-a456-426614174000","supportedFeatures":"599E51", "guami":{"plmnId":{"mcc":"240","mnc":"060"},"amfId":"Fc4E30"}}' 

{
  "status": 403,
  "title": "Forbidden",
  "cause": "-",
  "detail": "n32c_handshake_unsuccessful"
}

Restore:

Sweden: 
sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_DE n32-c enabled true
commit


############################################
# UC20: Changing log levels                #
############################################

Normal Containers (config map)
-------------------------------
export SEPP_M_POD=$(kubectl get pods -n $NAMESPACE -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")

k edit configmap eric-sepp-manager-loglevel-config

k logs $SEPP_M_POD -c eric-sepp-manager -f | grep N32cInterface | jl


ENVOY
--------
export SEPP_POD=$(kubectl get pods -n $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
kubectl -n $NAMESPACE exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=trace"  
kubectl -n $NAMESPACE exec -it $SEPP_POD  -c eric-sepp-worker --  curl -X POST "http://localhost:9901/logging?level=info"  

Better: 

kubectl -n $NAMESPACE exec -it $SEPP_POD -c eric-sepp-worker -- curl -X POST "http://localhost:9901/logging?connection=trace"


  envoy_bug: info
  eric_proxy: info
  eric_ingress_ratelimit: info
  eric_tap: info
  http2: info
conn_manager_impl

  connection: info
  conn_handler: info



reset; k logs -f $SEPP_POD -c eric-sepp-worker --tail=0  | jl3



############################################
# UC30: vTAP                               #
############################################

Preparation:
export SFTP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-atmoz-sftp )
export SEPP_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")

sshpass -p admin sftp -P $SFTP_PORT admin@$NODE_IP
cd data
rm *
exit

k get cm | grep tap
k get cm eric-sc-tap-config -o yaml

k edit configmap eric-sc-tap-config
# 
wait 1 min

k logs -f $SEPP_POD -c tapagent --tail=0 | jl

#k get cm eric-sepp-worker-tap-config -o yaml | sed 's/true/false/g' | k create cm eric-sepp-worker-tap-config -o yaml --dry-run=client | k apply -f - 
#k get cm eric-SEPP-manager-tap-config -o yaml | sed 's/false/true/g' | k create cm eric-SEPP-manager-tap-config -o yaml --dry-run=client | k apply -f - 


k patch cm/eric-sepp-worker-tap-config --type merge -p '{"data":{"tap_config.json":"[\n       {\n            \"TAP_ENABLED\": true\n       }\n]\n"}}'
k patch cm/eric-sepp-worker-tap-config --type merge -p '{"data":{"tap_config.json":"[\n       {\n            \"ServiceName\": \"eric-sepp-worker\",\n            \"TAP_ENABLED\": true,\n            \"TracingMode\": \"sftp\",\n            \"TAP_INT\": \"eth0\",\n            \"NF_TYPE\": \"sepp\",\n            \"TAP_FILTER\": \"port 80\"\n       }\n]\n"}}'
k patch cm/eric-sepp-worker-tap-config --type merge -p '{"data":{"tap_config.json":"[\n       {\n            \"ServiceName\": \"eric-sepp-worker\",\n            \"TAP_ENABLED\": false,\n            \"TracingMode\": \"sftp\",\n            \"TAP_INT\": \"eth0\",\n            \"NF_TYPE\": \"sepp\",\n            \"TAP_FILTER\": \"port 80\"\n       }\n]\n"}}'

k get cm eric-sc-tap-config -o yaml | sed 's/true/false/g' | k replace -f -
k get cm eric-sc-tap-config -o yaml | sed 's/false/true/g' | k replace -f -

k get cm eric-sc-tap-config -o yaml | sed 's/true/false/g' | k replace -f -
k get cm eric-sc-tap-config -o yaml | sed 's/false/true/g' | k replace -f -


k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-manager\",\n\s+\"TAP_ENABLED\": )false/\1true/' | k replace -f -
k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-worker\",\n\s+\"TAP_ENABLED\": )false/\1true/' | k replace -f -

#wait 1min
k logs -f $SEPP_POD -c tapagent --tail=0 | jl

export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

# sent from RP_BE  (SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP"  \
"https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-target-apiRoot:https://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' \
--cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem    2>&1 | grep '^[<>]'


k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-worker\",\n\s+\"TAP_ENABLED\": )true/\1false/' | k replace -f -
#wait 1min


# sent 1000 messages from RP_BE  (SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP"  \
"https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access?a=[1-1000]" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' \
--cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem  2>&1 | grep '^[<>]'


sshpass -p admin sftp -P $SFTP_PORT admin@$NODE_IP
cd data
ls -ltra
get *
exit


#Wireshark update on the fly, does not work for HTTPS messages though!
cd ~/demo/traces
sshpass -p admin sftp -P $SFTP_PORT admin@$NODE_IP <<< "get data/*"
sshpass -p admin sftp -P $SFTP_PORT admin@$NODE_IP <<< "rm data/*"

$ tail -f -c +0 *.pcap | wireshark -k -i -



open in Wireshark


############################################
# UC30a: vTAP - HTTP capture (single shot) #
############################################

Preparation:
export SFTP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-atmoz-sftp )
export SEPP_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-worker" -o jsonpath="{.items[0].metadata.name}")
export SEPP_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[0].nodePort}" services eric-sepp-worker)


k edit configmap eric-sc-tap-config
{
     "ServiceName": "eric-sepp-worker",
     "TAP_ENABLED": true,
     "TracingMode": "sftp",
     "TAP_INT": "eth0",
     "NF_TYPE": "sepp",
     "TAP_FILTER": "port 80"
},

# set to "true" sepp-worker trace
wait 1 min

k logs -f $SEPP_POD -c tapagent --tail=0 | jl

# sent to Pool "Pool_UDM_fw", UDM1 or UDM2 selected (round robin)
curl -v --http2-prior-knowledge  -X PUT --resolve "scp1.region1.scp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT:$NODE_IP" \
"http://scp1.region1.scp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_PORT/nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-Discovery-nf-set-id:set1.udmset.5gc.mnc072.mcc262" \
-H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfAmf.region1.amf.5gc.mnc072.mcc262.3gppnetwork.org", "guami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"Fc4E30"}, "ratType":"NR"}' | jq


k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-worker\",\n\s+\"TAP_ENABLED\": )true/\1false/' | k replace -f -
#wait 1min




############################################
# UC30b: vTAP - HTTPs capture (single shot)#
############################################

NOTE:
in order to decrypt HTTPS messages, the tlskeylogagent (vtap lite) must capture the TLS handshake that takes place in the beginning in order to store the key in a txt file

Load the SSL key log file in Tshark (the command-line version of Wireshark)
Specify the tls.keylog_file:<file> option on the Tshark command line. For example:
    tshark -o 'tls.keylog_file:logfile.pms' -r capture.pcap

editcap --inject-secrets tls,eric-sepp-worker-78cc486f5-5bz6p-2023-02-24T14-01-49.txt eric-sepp-worker-78cc486f5-5bz6p-2023-02-24T14-01-48.pcap eric-sepp-worker-78cc486f5-5bz6p-2023-02-24T14-01-48_with_keys.pcap


NOTE: port 444 is needed in SEPP, since it is used to receive HTTPS from RP

export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

{
     "ServiceName": "eric-sepp-worker",
     "TAP_ENABLED": true,
     "TracingMode": "sftp",
     "TAP_INT": "eth0",
     "NF_TYPE": "sepp",
     "TAP_FILTER": "port 80 or port 444 or port 443"
},
#k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-worker\",\n\s+\"TAP_ENABLED\": )false/\1true/' | k replace -f -


# sent from RP_BE  (SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP"  \
"https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' \
--cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem   2>&1 | grep '^[<>]'



k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-worker\",\n\s+\"TAP_ENABLED\": )true/\1false/' | k replace -f -
#wait 1min




#############################################
# UC30c: vTAP - HTTP, with capt.filter (NRF)#
#############################################
#VDI:
#Configure a wrong port for NRF and then the correct one to trigger a MAGIC packet
cat ~/demo/sepp_demo/sepp_demo_wrong_nrf_port.xml | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf | grep "<rpc-reply"
cat ~/demo/sepp_demo/sepp_demo_correct_nrf_port.xml | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf | grep "<rpc-reply"

export SCPM_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-sepp-manager" -o jsonpath="{.items[0].metadata.name}")

k logs -f $SCPM_POD -c tapagent --tail=0 | jl


export NRF_IP=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-nrfsim" -o jsonpath="{.items[0].status.podIP}")

{
     "ServiceName": "eric-sepp-manager",
     "TAP_ENABLED": true,
     "TracingMode": "sftp",
     "TAP_INT": "eth0",
     "NF_TYPE": "sepp",
     "TAP_FILTER": "port 80 and ip host 192.168.161.148 -c 20"
}


k get cm eric-sc-tap-config -o yaml | sed -zE 's/(eric-sepp-manager\",\n\s+\"TAP_ENABLED\": )true/\1false/' | k replace -f -

can use for any tcpdump options, e.g. also -c 100


############################################
# UC30d: traffic                           #
############################################


a) copy files to K6 if not already done:
export K61_POD=$(kubectl get pods --namespace $NAMESPACE -l "app=eric-k6" -o jsonpath="{.items[0].metadata.name}")
k cp ~/demo/scp_demo/scp_stability_test_set1_b.js ${K61_POD}:/tests/scp_stability_test_set1.js
k cp $GIT_PATH/5g_proto/.certificates/scpwrk/cert.pem ${K61_POD}:/certs/K6.crt
k cp $GIT_PATH/5g_proto/.certificates/scpwrk/key.pem ${K61_POD}:/certs/K6.key



export SEPP_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker)
echo $SEPP_TLS_PORT; echo $NODE_IP

k exec -it $K61_POD -- sh

# start 1000 TPS on RR traffic, about 20% load on SEPP
k exec -it $K61_POD -- k6 run -e SEPP_HOST=scp1.region1.scp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=$NODE_IP -e SEPP_PORT=$SEPP_TLS_PORT -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=1000 -e HOLDDURATION=600s -e RAMPDURATION=1s scp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report

# start 4000 TPS on RR traffic, about 80% load on SEPP  -> 2 sepp-workers, no space for 3
k exec -it $K61_POD -- k6 run -e SEPP_HOST=scp1.region1.scp.5gc.mnc072.mcc262.3gppnetwork.org -e SEPP_IP=$NODE_IP -e SEPP_PORT=$SEPP_TLS_PORT -e SET=set1.udmset.5gc.mnc072.mcc262 -e RPS=4000 -e HOLDDURATION=600s -e RAMPDURATION=1s scp_stability_test_set1.js --insecure-skip-tls-verify  --no-usage-report




##################################################
# UC31: vTAP PVTB - HTTPs capture (single shot)  # (SC 1.8+) SC 1.10+ with egress
##################################################

#deploy vtaprecorder
cd $GIT_PATH/5g_proto/simulators/vtaprecorder
make deploy


k delete <probebroker> 
kgp -o wide |grep  vtap  # take the cluster-ip for vtap pod and use it below in the address of the stream_consumer


sepp-function nf-instance instance_1
 vtap enabled true
 vtap vtap-configuration proxy ingress own_tap
  external-network-ref [ externalNetwork ]
  enabled true
 vtap vtap-configuration proxy egress egress_tap
  nf-pool-ref [ sepp_RP_BE_pool ]
  enabled true
  
vtap profiles profile vtap_profile1 domain sc-sepp protocol raw-sbi
vtap stream-consumers stream-consumer stream_consumer_1 address 192.168.74.77 tapping-profile vtap_profile1
vtap enabled true

#Maximum of five streaming consumers can be configured.

# show output
echo "show running-config sepp-function nf-instance instance_1 vtap" | sshpass -p rootroot ssh -p $CLI_PORT expert@$NODE_IP 2> /dev/null
echo "show running-config vtap" | sshpass -p rootroot ssh -p $CLI_PORT expert@$NODE_IP 2> /dev/null


export TAPREC_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-vtaprecorder-0)
echo $TAPREC_PORT; echo $NODE_IP

curl -X POST $NODE_IP:$TAPREC_PORT/start
curl -X POST $NODE_IP:$TAPREC_PORT/stop
curl -X GET $NODE_IP:$TAPREC_PORT/status | jq
curl -X GET $NODE_IP:$TAPREC_PORT/pcapng --output "$(date +"%FT%H%M%S").pcapng"



export SEPP_EXT_TLS_PORT=$(kubectl get --namespace $NAMESPACE -o jsonpath="{.spec.ports[1].nodePort}" services eric-sepp-worker-2)

# sent from RP_BE  (SAN: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org Domain-name: *.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org)
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP"  \
"https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" \
-H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" \
-d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' \
--cert ~/demo/sepp_demo/certificates/RP_206033-sepp-cert.pem --key ~/demo/sepp_demo/certificates/RP_206033-sepp-key.pem --cacert ~/demo/sepp_demo/certificates/rootCA_DE-cert.pem  2>&1 | grep '^[<>]'


#open pcap file in Wireshark, SORT BY TIME!!
## In Wireshark decode as 443 -> HTTP2 (contradicts what we need for vtap lite!)  <-----------------
##
## Benefits of vTAP PVTB, no session-key file needed, filter on egress Pool -> good for bulk tracing and troubleshooting, if good tap receiver used like XFO, Netscout etc


#Create seppsim secret 
k get secret sc-traf-root-ca-list1-secret -o jsonpath="{.data['*']}" | base64 -d > rootCA.crt
ln -s RP_206033.crt cert.pem
ln -s RP_206033.key key.pem 
k delete secret seppsim-certificates-p3
k create secret generic seppsim-certificates-p3  --from-file=./cert.pem  --from-file=./key.pem  --from-file=./rootCA.crt







############################################
# UC40a: Message screening, category 1     #
#        Unique per Roaming Partner        #
############################################


Not allow 3GppRegistration from non-3gpp access


/{ueId}/registrations/amf-non-3gpp-access


#cat ~/demo/sepp_demo/config_addon_ms.txt | sshpass -p seppsepp ssh -t -p $YP_PORT sepp-admin@$NODE_IP -s netconf


sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP

autowizard false
config

sepp-function nf-instance instance_1
 message-data 3GppRegistration
  path
  extractor-regex "/nudm-uecm/v1/imsi-\d+/registrations/(?P<reg>[\w\-]+)$"
 !
!
top
sepp-function nf-instance instance_1
 request-screening-case ingress_req_from_RP_BE
  message-data-ref [ 3GppRegistration ]
  screening-rule category1
   condition var.reg=='amf-non-3gpp-access'
   screening-action reject_cat1_message
    action-reject-message status 503
    action-reject-message title "Service Unavailable"
    action-reject-message detail "amf-non-3gpp-access not allowed for RP_BE"
    action-reject-message format json
   !
  !
 !
!
top
sepp-function nf-instance instance_1
 external-network externalNetwork
  roaming-partner RP_BE
   in-request-screening-case-ref ingress_req_from_RP_BE
  !
 !
!

top 
show configuration
commit
end
exit


# sent from RP_BE with path amf-3gpp-access -> OK
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key | jq


# sent from RP_BE with path amf-non-3gpp-access -> OK rejected
curl --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-non-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "imsVoPs":"HOMOGENEOUS_NON_SUPPORT", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"EUTRA"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key | jq



# sent from RP_SE, amf-non-3gpp-access accepted 
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-non-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "imsVoPs":"HOMOGENEOUS_NON_SUPPORT", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org", "guami":{"plmnId":{"mcc":"240","mnc":"060"},"amfId":"Fc4E30"}, "ratType":"EUTRA"}' -k --cert ~/demo/sepp_demo/RP_240060.crt --key ~/demo/sepp_demo/RP_240060.key  | jq


############################################
# UC40b: Message screening, category 2     #
############################################

Only allow own subscribers to register in home UDM


sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP

autowizard false
config

sepp-function nf-instance instance_1
 message-data imsi_mcc_mnc
  path 
  extractor-regex "/nudm-uecm/v1/imsi-(?P<mcc>\d\d\d)(?P<mnc>\d\d\d).*/registrations"
 !
!

sepp-function nf-instance instance_1
 request-screening-case ingress_req_from_all_RP
  message-data-ref [ imsi_mcc_mnc ]
  screening-rule category2
   condition "not (var.mcc=='262' and var.mnc=='072') and not (var.mcc isempty or var.mnc isempty)"
   screening-action reject_cat2_message
    action-reject-message status 503
    action-reject-message title "Service Unavailable"
    action-reject-message detail "Registration only allowed for Home PLMN IMSI series"
    action-reject-message format json
   !
  !
 !
!

sepp-function nf-instance instance_1
 request-screening-case ingress_req_from_RP_BE
  screening-rule apply_also_global_screening
   condition ""
   screening-action continue_with_global_screening
    action-go-to request-screening-case-ref ingress_req_from_all_RP
   !
  !
 !
!

sepp-function nf-instance instance_1
 external-network externalNetwork
   in-request-screening-case-ref ingress_req_from_all_RP
!

top 
show configuration
commit
end
exit



# sepp-function nf-instance instance_1
#  request-screening-case ingress_req_from_RP_BE
#   message-data-ref [ 3GppRegistration ]
#   screening-rule category1
#    condition var.reg=='amf-non-3gpp-access'
#    screening-action reject_cat1_message
#     action-reject-message status 503
#     action-reject-message title "Service Unavailable"
#     action-reject-message detail "amf-non-3gpp-access not allowed for RP_BE"
#     action-reject-message format json
#    !
#   !
#   screening-rule apply_also_global_screening
#    condition ""
#    screening-action continue_with_global_screening
#     action-go-to request-screening-case-ref ingress_req_from_all_RP
#    !
#   !
#  !
#  request-screening-case ingress_req_from_all_RP
#   message-data-ref [ imsi_mcc_mnc ]
#   screening-rule category2
#    condition "not (var.mcc=='262' and var.mnc=='072')"
#    screening-action reject_cat2_message
#     action-reject-message status 503
#     action-reject-message title "Service Unavailable"
#     action-reject-message detail "Registration only allowed for Home PLMN IMSI series"
#     action-reject-message format json
#    !
#   !
#  !
# !




# sent from RP_BE with correct IMSI series -> OK
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620720007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key 2>&1 | grep '^[<>]'

# sent from RP_BE with wrong IMSI series, rejected in global RP screening
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620770007487/registrations/amf-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc033.mcc206.3gppnetwork.org", "guami":{"plmnId":{"mcc":"206","mnc":"033"},"amfId":"Fc4E30"}, "ratType":"NR"}' -k --cert ~/demo/sepp_demo/RP_206033.crt --key ~/demo/sepp_demo/RP_206033.key | jq

# sent from RP_SE with wrong IMSI series, rejected in global RP screening
curl -v --http2-prior-knowledge  -X PUT --resolve "sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT:$NODE_IP" "https://sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org:$SEPP_EXT_TLS_PORT/nudm-uecm/v1/imsi-2620770007487/registrations/amf-non-3gpp-access" -H "3gpp-Sbi-target-apiRoot:http://nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org" -H "Content-Type: application/json" -d '{"amfInstanceId": "fde21b56-2e47-49dd-9a1f-2769e5a8f45d", "imsVoPs":"HOMOGENEOUS_NON_SUPPORT", "deregCallbackUri": "http://nfamf.region1.amf.5gc.mnc060.mcc240.3gppnetwork.org", "guami":{"plmnId":{"mcc":"240","mnc":"060"},"amfId":"Fc4E30"}, "ratType":"EUTRA"}' -k --cert ~/demo/sepp_demo/RP_240060.crt --key ~/demo/sepp_demo/RP_240060.key | jq


Restore
-------

sshpass -p seppsepp ssh -t -p $CLI_PORT sepp-admin@$NODE_IP

config
no sepp-function nf-instance instance_1 message-data 3GppRegistration 
no sepp-function nf-instance instance_1 message-data imsi_mcc_mnc    
no sepp-function nf-instance instance_1 request-screening-case ingress_req_from_all_RP 
no sepp-function nf-instance instance_1 request-screening-case ingress_req_from_RP_BE  
no sepp-function nf-instance instance_1 external-network externalNetwork in-request-screening-case-ref 
no sepp-function nf-instance instance_1 external-network externalNetwork roaming-partner RP_BE in-request-screening-case-ref 
commit
end
exit


============
Appendix A:
============

Ericsson DE: MCC 262    MNC 72  sepp-de.region1.sepp.5gc.mnc072.mcc262.3gppnetwork.org
                                nfudm1.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org
                                nfudm2.region1.udm.5gc.mnc072.mcc262.3gppnetwork.org
                                
Ericsson BE: MCC 206    MNC 33  sepp-be.region1.sepp.5gc.mnc033.mcc206.3gppnetwork.org 
                                nfudm-be.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org
                                
Ericsson SE: MCC 240    MNC 60  sepp-se.region1.sepp.5gc.mnc060.mcc240.3gppnetwork.org
                                nfudm-se.region1.udm.5gc.mnc033.mcc206.3gppnetwork.org  
                                

Ericsson FI: MCC 244    MNC 99          
Ericsson DK: MCC 238    MNC 40

============
Appendix B:
============

N32 (SEPP-SEPP): 
  
N8 (AMF-UDM) 
    TS 29.518
    UDM->AMF    Namf_Communication  
        AMFStatusChangeSubscribe, AMFStatusChangeUnSubscribe, AMFStatusChangeNotify 
        /namf-comm/v1
            /ue-contexts/{ueContextId}
            /ue-contexts/{ueContextId}/release
            /ue-contexts/{ueContextId}/assign-ebi
            /ue-contexts/{ueContextId}/transfer
    UDM->AMF    Namf_EventExposure  
        Subscribe, UnSubscribe, Notify
        /namf-evts/v1
            /subscriptions
    UDM->AMF    Namf_Location   
        ProvideLocationInfo
        /namf-loc/v1
            /{ueContextId}/provide-pos-info  
    UDM->AMF    Namf_MT 
        ProvideDomainSelectionInfo
        /namf-mt/v1
            /ue-contexts/{ueContextId}

    TS 29.503
    AMF-> UDM   Nudm_SubscriberDataManagement
        Get, Subscribe, ModifySubscription, Unsubscribe, Notification
    AMF-> UDM   Nudm_SubscriberDataManagement   
        Info
--> AMF-> UDM   Nudm_UEContextManagement
        Registration, Deregistration, DeregistrationNotification, Get, Update
    AMF-> UDM   Nudm_UEContextManagement
        PCscfRestorationNotification        
        
N12 (AMF-AUSF)
    TS 29.509
    AMF->AUSF   Nausf_UEAuthentication  
        Authenticate

N27 (vNRF-hNRF)
    TS 29.510
    vNRF<->hNRF Nnrf_AccessToken    
        Get     
    vNRF<->hNRF Nnrf_NFDiscovery
        NFDiscover
    vNRF<->hNRF Nnrf_NFManagement
        NFRegister, NFUpdate, NFDeregister
    vNRF<->hNRF Nnrf_NFManagement
        NFStatusSubscribe, NFStatusNotify, NFStatusUnSubscribe, NFListRetrieval, NFProfileRetrieval
    vNRF<->hNRF NnrfBootstrapping
        Get

N21 (SMSF-UDM) 
    TS 29.503
    SMSF->UDM   Nudm_SubscriberDataManagement   
        Get, Subscribe, ModifySubscription, Unsubscribe, Notification
    SMSF->UDM   Nudm_UEContextManagement
        Registration/Deregistration
    SMSF->UDM   Nudm_UEContextManagement
        Get
        
N16 (vSMF-hSMF)
    TS 29.502
    H-SMF<->V-SMF   Nsmf_PDUSession
        Create, Update, Release, StatusNotify   

    /sm-contexts:
    /sm-contexts/{smContextRef}/retrieve:
	/sm-contexts/{smContextRef}/modify:
	/sm-contexts/{smContextRef}/release:
	/sm-contexts/{smContextRef}/send-mo-data:
	/pdu-sessions:
	/pdu-sessions/{pduSessionRef}/modify:
	/pdu-sessions/{pduSessionRef}/release:
	/pdu-sessions/{pduSessionRef}/retrieve:
	/pdu-sessions/{pduSessionRef}/transfer-mo-data:
	

N24 (vPCF-hPCF) ???
    TS 29.525

Npcf_UEPolicyControl




--------------------------------------------------------------------------------------------------------------------------------------------
    UDM->AMF    Namf_Communication  
        AMFStatusChangeSubscribe, AMFStatusChangeUnSubscribe, AMFStatusChangeNotify 
        /namf-comm/v1
            /ue-contexts/{ueContextId}
            /ue-contexts/{ueContextId}/release
            /ue-contexts/{ueContextId}/assign-ebi
            /ue-contexts/{ueContextId}/transfer
			
N1N2 Message Subscribe
This POST request is used by NF service consumers (UDM) to subscribe to the AMF for notification of UE-specific N1 messages of a specific type or N2 information of a specific type. 
Direction: NF Service Consumer --> AMF			
 
curl -v -X POST "http://$NODE_IP:$C_SEPPSIM_PORT/namf-comm/v1/ue-contexts/imsi-123456789/n1-n2-messages/subscriptions" -H "3gpp-sbi-target-apiroot: sepp-1.rp-1.de:8082" -H "Content-Type: application/json" -d '{"n2InformationClass":"SM","n2NotifyCallbackUri":"ericsson.com/sample/uri?n=2","n1MessageClass":"5GMM","n1NotifyCallbackUri":"ericsson.com/sample/uri?n=1","nfId":"123e4567-e89b-12d3-a456-426614174000","supportedFeatures":"599E51","oldGuami":{"plmnId":{"mcc":"262","mnc":"072"},"amfId":"57Fbde"}}' | jq

--------------------------------------------------------------------------------------------------------------------------------------------

--> AMF-> UDM   Nudm_UEContextManagement
nudm-uecm/v1
        Registration (Retrieve UEs registration data sets)
        The Nudm_UECM_Registration service operation is used by NFs (AMF, SMF, SMSF)
        to register at the UDM as the NF serving the UE (AMF and SMSF) 
        
PUT   nudm-uecm/v1/{ueId}/registrations/amf-3gpp-access

example:
PUT /nudm-uecm/v1/imsi-2089300007487/registrations/amf-3gpp-access

        registrationData := models.Amf3GppAccessRegistration{
            AmfInstanceId:          amfSelf.NfId,
            InitialRegistrationInd: initialRegistrationInd,
            Guami:                  &amfSelf.ServedGuamiList[0],
            RatType:                ue.RatType,
            // TODO: not support Homogenous Support of IMS Voice over PS Sessions this stage
            ImsVoPs: models.ImsVoPs_HOMOGENEOUS_NON_SUPPORT,

ueId:       
SUPI (i.e. imsi or nai) or GPSI (i.e. msisdn or extid) is used with the GET method.     
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Amf3GppAccessRegistration'


      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Amf3GppAccessRegistration'
          headers:
            Location:
              description: 'Contains the URI of the newly created resource, according to the structure: {apiRoot}/nudm-uecm/v1/{ueId}/registrations/amf-3gpp-access'
              required: true
              schema:
                type: string


        Deregistration, DeregistrationNotification, Get, Update
		
		
		
        
FROM 3GPP TS 29.503:
--------------------
5.3.2.2.2   AMF registration for 3GPP access 
Figure 5.3.2.2.2-1 shows a scenario where the AMF sends a request to the UDM to update the AMF registration
information for 3GPP access (see also 3GPP TS 23.502 [3] figure 4.2.2.2.2-1 step 14). The request contains the UE's
identity (/{ueId}) which shall be a SUPI and the AMF Registration Information for 3GPP access.

AMF UDM
1. PUT /{ueId}/registrations/amf-3gpp-access
(Amf3GppAccessRegistration)
2a. 204 No Content
2b. 201 Created
2c. 403 Forbidden

Figure 5.3.2.2.2-1: AMF registering for 3GPP access

1. The AMF sends a PUT request to the resource representing the UE's AMF registration for 3GPP access to update or create AMF registration information.

2a. On success, and if another AMF is registered for 3GPP access, the UDM updates the Amf3GppAccessRegistration resource by replacing it with the received resource information, and responds with "204 No Content".
 UDM shall invoke the Deregistration Notification service operation towards the old AMF using the callback URI provided by the old AMF.
 
2b. If the resource does not exist (there is no previous AMF information stored in UDM for that user), UDM stores the received AMF registration data for 3GPP access and responds with HTTP Status Code "201 created". A response body may be included to convey additional information to the NF consumer (e.g., features supported by UDM).

2c. If the operation cannot be authorized due to e.g UE does not have required subscription data, access barring or roaming restrictions, HTTP status code "403 Forbidden" should be returned including additional error information in the response body (in "ProblemDetails" element). 
        
Amf3GppAccessRegistration 6.2.6.2.2 The complete set of information relevant to the AMF where the UE has registered via 3GPP access.        

6.2.6.2.2 Type: Amf3GppAccessRegistration
Table 6.2.6.2.2-1: Definition of type Amf3GppAccessRegistration
Attribute name          Data type           P Cardinality   Description
amfId                   NfInstanceId        M 1             Identifier of the serving AMF. It shall be formatted as
                                                            a Globally Unique AMF ID, as defined in
                                                            3GPP TS 23.003 [8]. fde21b56-2e47-49dd-9a1f-2769e5a8f45d
supportedFeatures       SupportedFeatures   O 0..1          See subclause 6.2.8
purgeFlag               PurgeFlag           O 0..1          This flag indicates whether or not the AMF has
                                                            deregistered. It shall not be included in the       
                                                            Registration service operation.
pei                     Pei                 O 0..1          Permanent Equipment Identifier.
imsVoPS                 ImsVoPS             O 0..1          Indicates per UE if "IMS Voice over PS Sessions" is
                                                            homogeneously supported in all TAs in the serving
                                                            AMF, or homogeneously not supported, or if support
                                                            is non-homogeneous/unknown. Absence of this
                                                            attribute shall be interpreted as "non homogenous or unknown" support.
deregCallbackUri        Uri                 M 1             A URI provided by the AMF to receive (implicitly
                                                            subscribed) notifications on deregistration.
pcscfRestorationCallbackUri Uri             O 0..1          A URI provided by the AMF to receive (implicitly
                                                            subscribed) notifications on the need for P-CSCF Restoration.

Optional attributes of this type that are also attributes of the derived type Amf3GppAccessRegistrationModification
(see clause 6.2.6.2.7) shall not be marked with "nullable : true" in the OpenAPI file. 



============
Appendix B:
============

28.12 NF Set Identifier (NF Set ID)
A NF Set Identifier is a globally unique identifier of a set of equivalent and interchangeable CP NFs from a given network that provide distribution, redundancy and scalability (see clause 5.21.3 of 3GPP TS 23.501 [119]).

An NF Set Identifier shall be constructed from the MCC, MNC, NID (for SNPN), NF type and a Set ID.

A NF Set Identifier shall be formatted as the following string:

set<Set ID>.<nftype>set.5gc.mnc<MNC>.mcc<MCC> for a NF Set in a PLMN, or

set<Set ID>.<nftype>set.5gc.nid<NID>.mnc<MNC>.mcc<MCC> for a NF Set in a SNPN.

where:

 the <MCC> and <MNC> shall identify the PLMN of the NF Set and shall be encoded as follows:

 <MCC> = 3 digits

 <MNC> = 3 digits

If there are only 2 significant digits in the MNC, one "0" digit shall be inserted at the left side to fill the 3 digits coding of MNC.

 the Network Identifier (NID) shall be encoded as hexadecimal digits as specified in clause 12.7.

 the <NFType> shall identify the NF type of the NFs within the NF set and shall be encoded as a value of Table 6.1.6.3.3-1 of 3GPP TS 29.510 [130] but with lower case characters;

 the Set ID shall be a NF type specific Set ID within the PLMN, chosen by the operator, that shall consist of alphabetic characters (A-Z and a-z), digits (0-9) and/or the hyphen (-) and that shall end with either an alphabetic character or a digit;

 the case of alphabetic characters is not significant (i.e. two NF Set IDs with the same characters but using different lower and upper cases identify the same NF Set).

For an AMF set, the Set ID shall be set to "<AMF Set ID>.region<AMF Region ID>", with the AMF Region ID and AMF Set ID encoded as defined in 3GPP TS 29.571 [129].

EXAMPLE 1: setxyz.smfset.5gc.mnc012.mcc345

EXAMPLE 2: set12.pcfset.5gc.mnc012.mcc345

EXAMPLE 3: set1.region48.amfset.5gc.mnc012.mcc345 (for AMF Region 48 (hexadecimal) and AMF Set 1)

EXAMPLE 4: setxyz.smfset.5gc.nid000007ed9d5.mnc012.mcc345 for a SNPN with the NID 000007ed9d5 (hexadecimal).

NOTE: If needed, an FQDN can be derived from a given NF Set ID by appending the ".3gppnetwork.org" domain to the NF Set ID, see e.g. SMF Set FQDN in clause 28.3.2.9. For NFs whose NF type contains an underscore and for which an FQDN needs to be derived, the underscore is replaced by an hyphen in the corresponding label of the FQDN.

NF Instances of an NF Set are equivalent and share the same MCC, MNC, NID (for SNPN), NF type and NF Set ID.

28.13 NF Service Set Identifier (NF Service Set ID)
A NF Service Set Identifier is a globally unique identifier of a set of equivalent and interchangeable CP NF service instances within a NF instance from a given network that provide distribution, redundancy and scalability (see clause 5.21.3 of 3GPP TS 23.501 [119]).

An NF Service Set Identifier shall be constructed from the MCC, MNC, NID (for SNPN), NF instance Identifier, service name and a Set ID.

A NF Service Set Identifier shall be formatted as the following string:

set<Set ID>.sn<Service Name>.nfi<NF Instance ID>.5gc.mnc<MNC>.mcc<MCC> for a NF Service Set in a PLMN, or

set<Set ID>.sn<Service Name>.nfi<NF Instance ID>.5gc.nid<NID>.mnc<MNC>.mcc<MCC> for a NF Service Set in a SNPN.

where:

 the <MCC> and <MNC> shall identify the PLMN of the NF Service Set and shall be encoded as follows:

 <MCC> = 3 digits

 <MNC> = 3 digits

If there are only 2 significant digits in the MNC, one "0" digit shall be inserted at the left side to fill the 3 digits coding of MNC.

 the Network Identifier (NID) shall be encoded as hexadecimal digits as specified in clause 12.7.

 the NFInstanceID shall identify the NF instance of the NF Service set, as defined by 3GPP TS 23.501 [119] and 3GPP TS 29.510 [130];

 the ServiceName shall identify the NF service of the NF Service set, as defined by 3GPP TS 29.510 [130];

 the Set ID shall be a service specific Set ID within the NF instance, chosen by the operator that shall consist of alphabetic characters (A-Z and a-z), digits (0-9) and/or the hyphen (-) and that shall end with either an alphabetic character or a digit;

 the case of alphabetic characters is not significant (i.e. two NF Service Set IDs with the same characters but using different lower and upper cases identify the same NF Service Set).

EXAMPLE 1: setxyz.snnsmf-pdusession.nfifde21b56-2e47-49dd-9a1f-2769e5a8f45d.5gc.mnc012.mcc345

EXAMPLE 2: set2.snnpcf-smpolicycontrol.nfifde21b56-2e47-49dd-9a1f-2769e5a8f45d.5gc.mnc012.mcc345

EXAMPLE 3: setxyz.snnsmf-pdusession.nfifde21b56-2e47-49dd-9a1f-2769e5a8f45d.5gc.nid000007ed9d5.mnc012.mcc345 for a SNPN with the NID 000007ed9d5 (hexadecimal).

NF service instances from different NF instances are equivalent NF service instances if they share the same MCC, MNC, NID (for SNPN), ServiceName and Set ID.

NF Service Sets belonging to different NF Instances are said to be equivalent, if they share the same MCC, MNC, NID (for SNPN), ServiceName and Set ID.


============
Appendix C:
============


Official Document NG.113 - 5GS Roaming Guidelines


4.2 Inter-PLMN (N32) Interface
The Inter-PLMN specification 3GPP TS 29.573 [10] has been produced by 3GPP to specify
the protocol definitions and message flows, and also the APIs for the procedures on the
PLMN (Public Land Mobile Network) interconnection interface (i.e. N32)
As stated in 3GPP TS 29.573 [10] the N32 interface is used between the SEPPs of a VPMN
and a HPMN in roaming scenarios. Furthermore, 3GPP has specified N32 to be considered
as two separate interfaces: N32-c and N32-f.
4.2.1 N32-c Interface
N32-c is the Control Plane interface between the SEPPs for performing the initial handshake
and negotiating the parameters to be applied for the actual N32 message forwarding. See
section 4.2.2 of 3GPP TS 29.573 [10].

SEPP in           SEPP in
PLMN A    N32-c   PLMN B 


Figure 5  N32-c Interface
Once the initial HTTP/2 handshake is completed the N32-c connection is torn down. This
connection is End-to-End between SEPPs and does not involve IPX to intercept the HTTP/2
connection; although the IPX may be involved for IP level routing.

4.5.2 SEPP administration, naming conventions and routing
A SEPP will be identified by an FQDN, and corresponding IP-address obtained via SRV and
(A or AAAA) procedures. In case of a single SEPP (cluster) deployment this may be the wellknown FQDN sepp.5gc.mnc<MNC>.mcc<MCC>.3gppnetwork.org.
In case of multiple SEPPs the FQDN may be presented as (depicted as left FQDN hierarchy
in the figure below):
sepp<id>.5gc.mnc<MNC>.mcc<MCC>.3gppnetwork.org (MNO SEPP)

SEPP<id> is as specified in Section 13.2.2.4.2 of 3GPP TS 33.501 [19]. 


7.2.3.1 Fully Qualified Domain Names (FQDNs)
Section 6.1.4.3 of 3GPP TS 29.500 [20] specifies how HTTP/2 request messages are routed
between PLMNs, where the correct target NF service should be reached. Where the target
URI authority designates an origin server not in the same PLMN as the client, the authority
HTTP/2 pseudo-header shall contain the FQDN including the PLMN ID.
The format of the FQDN of the target NF service is specified in 3GPP TS 23.003 [28]
Section 28.5. For HTTP/2 request messages to a NF service in different PLMN, the FQDN
of the target NF shall have the Home Domain as the trailing part  i.e.
 5gc.mnc<MNC>.mcc<MCC>.3gppnetwork.org



